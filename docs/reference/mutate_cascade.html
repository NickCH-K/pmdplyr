<!-- Generated by pkgdown: do not edit by hand -->
<!DOCTYPE html>
<html lang="en">
  <head>
  <meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<title>Perform mutate one time period at a time ('Cascading mutate') — mutate_cascade • pmdplyr</title>


<!-- jquery -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script>
<!-- Bootstrap -->

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous" />

<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script>

<!-- bootstrap-toc -->
<link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script>

<!-- Font Awesome icons -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous" />

<!-- clipboard.js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script>

<!-- headroom.js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script>

<!-- pkgdown -->
<link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script>




<meta property="og:title" content="Perform mutate one time period at a time ('Cascading mutate') — mutate_cascade" />
<meta property="og:description" content="This function is a wrapper for dplyr::mutate() which performs mutate one time period at a time, allowing each period's calculation to complete before moving on to the next. This allows changes in one period to 'cascade down' to later periods. This is (number of time periods) slower than regular mutate() and, generally, is only used for mutations where an existing variable is being defined in terms of its own lag() or tlag(). This is similar in concept to (and also slower than) cumsum but is much more flexible, and works with data that has multiple observations per individual-period using tlag(). For example, this could be used to calculate the current value of a savings account given a variable with each period's deposits, withdrawals, and interest, or could calculate the cumulative number of credits a student has taken across all classes." />




<!-- mathjax -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script>

<!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->



  </head>

  <body data-spy="scroll" data-target="#toc">
    <div class="container template-reference-topic">
      <header>
      <div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">pmdplyr</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.3.3</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
        <li>
  <a href="../index.html">
    <span class="fas fa fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../articles/pmdplyr.html">Get started</a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
    <li>
      <a href="../articles/dplyr_variants.html">pmdplyr: dplyr Variants</a>
    </li>
    <li>
      <a href="../articles/panel_tools.html">pmdplyr: Panel Tools</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
      <ul class="nav navbar-nav navbar-right">
        <li>
  <a href="https://github.com/NickCH-K/pmdplyr/">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
      
    </div><!--/.nav-collapse -->
  </div><!--/.container -->
</div><!--/.navbar -->

      

      </header>

<div class="row">
  <div class="col-md-9 contents">
    <div class="page-header">
    <h1>Perform mutate one time period at a time ('Cascading mutate')</h1>
    <small class="dont-index">Source: <a href='https://github.com/NickCH-K/pmdplyr/blob/master/R/major_mutate_variations.R'><code>R/major_mutate_variations.R</code></a></small>
    <div class="hidden name"><code>mutate_cascade.Rd</code></div>
    </div>

    <div class="ref-description">
    <p>This function is a wrapper for <code><a href='https://dplyr.tidyverse.org/reference/mutate.html'>dplyr::mutate()</a></code> which performs <code>mutate</code> one time period at a time, allowing each period's calculation to complete before moving on to the next. This allows changes in one period to 'cascade down' to later periods. This is (number of time periods) slower than regular <code>mutate()</code> and, generally, is only used for mutations where an existing variable is being defined in terms of its own <code><a href='https://rdrr.io/r/stats/lag.html'>lag()</a></code> or <code><a href='tlag.html'>tlag()</a></code>. This is similar in concept to (and also slower than) <code>cumsum</code> but is much more flexible, and works with data that has multiple observations per individual-period using <code><a href='tlag.html'>tlag()</a></code>. For example, this could be used to calculate the current value of a savings account given a variable with each period's deposits, withdrawals, and interest, or could calculate the cumulative number of credits a student has taken across all classes.</p>
    </div>

    <pre class="usage"><span class='fu'>mutate_cascade</span>(
  <span class='no'>.df</span>,
  <span class='no'>...</span>,
  <span class='kw'>.skip</span> <span class='kw'>=</span> <span class='fl'>TRUE</span>,
  <span class='kw'>.backwards</span> <span class='kw'>=</span> <span class='fl'>FALSE</span>,
  <span class='kw'>.group_i</span> <span class='kw'>=</span> <span class='fl'>TRUE</span>,
  <span class='kw'>.i</span> <span class='kw'>=</span> <span class='kw'>NULL</span>,
  <span class='kw'>.t</span> <span class='kw'>=</span> <span class='kw'>NULL</span>,
  <span class='kw'>.d</span> <span class='kw'>=</span> <span class='fl'>NA</span>,
  <span class='kw'>.uniqcheck</span> <span class='kw'>=</span> <span class='fl'>FALSE</span>,
  <span class='kw'>.setpanel</span> <span class='kw'>=</span> <span class='fl'>TRUE</span>
)</pre>

    <h2 class="hasAnchor" id="arguments"><a class="anchor" href="#arguments"></a>Arguments</h2>
    <table class="ref-arguments">
    <colgroup><col class="name" /><col class="desc" /></colgroup>
    <tr>
      <th>.df</th>
      <td><p>Data frame or tibble.</p></td>
    </tr>
    <tr>
      <th>...</th>
      <td><p>Specification to be passed to <code>mutate()</code>.</p></td>
    </tr>
    <tr>
      <th>.skip</th>
      <td><p>Set to <code>TRUE</code> to skip the first period present in the data (or present within each group for grouped data) when applying <code>mutate()</code>. Since most uses of <code>mutate_cascade()</code> will involve a <code><a href='https://rdrr.io/r/stats/lag.html'>lag()</a></code> or <code><a href='tlag.html'>tlag()</a></code>, this avoids creating an <code>NA</code> in the first period that then cascades down. By default this is TRUE. If you set this to FALSE you should probably have some method for avoiding a first-period <code>NA</code> in your <code>...</code> entry, perhaps using the <code>default</code> option in <code><a href='https://dplyr.tidyverse.org/reference/lead-lag.html'>dplyr::lag</a></code> or the <code>.default</code> option in <code>tlag</code>.</p></td>
    </tr>
    <tr>
      <th>.backwards</th>
      <td><p>Set to <code>TRUE</code> to run <code>mutate_cascade()</code> from the last period to the first, rather than from the first to the last.</p></td>
    </tr>
    <tr>
      <th>.group_i</th>
      <td><p>By default, if <code>.i</code> is specified or found in the data, <code>mutate_cascade</code> will group the data by <code>.i</code>, ignoring any grouping already implemented (although the original grouping structure will be returned at the end). Set <code>.group_i = FALSE</code> to avoid this.</p></td>
    </tr>
    <tr>
      <th>.i</th>
      <td><p>Quoted or unquoted variables that identify the individual cases. Note that setting any one of <code>.i</code>, <code>.t</code>, or <code>.d</code> will override all three already applied to the data, and will return data that is <code><a href='as_pibble.html'>as_pibble()</a></code>d with all three, unless <code>.setpanel=FALSE</code>.</p></td>
    </tr>
    <tr>
      <th>.t</th>
      <td><p>Quoted or unquoted variables indicating the time. <code>pmdplyr</code> accepts two kinds of time variables: numeric variables where a fixed distance <code>.d</code> will take you from one observation to the next, or, if <code>.d=0</code>, any standard variable type with an order. Consider using the <code><a href='time_variable.html'>time_variable()</a></code> function to create the necessary variable if your data uses a <code>Date</code> variable for time.</p></td>
    </tr>
    <tr>
      <th>.d</th>
      <td><p>Number indicating the gap in <code>.t</code> between one period and the next. For example, if <code>.t</code> indicates a single day but data is collected once a week, you might set <code>.d=7</code>. To ignore gap length and assume that "one period ago" is always the most recent prior observation in the data, set <code>.d=0</code>. The default <code>.d = NA</code> here will become <code>.d = 1</code> if either <code>.i</code> or <code>.t</code> are declared.</p></td>
    </tr>
    <tr>
      <th>.uniqcheck</th>
      <td><p>Logical parameter. Set to TRUE to always check whether <code>.i</code> and <code>.t</code> uniquely identify observations in the data. By default this is set to FALSE and the check is only performed once per session, and only if at least one of <code>.i</code>, <code>.t</code>, or <code>.d</code> is set.</p></td>
    </tr>
    <tr>
      <th>.setpanel</th>
      <td><p>Logical parameter. <code>TRUE</code> by default, and so if <code>.i</code>, <code>.t</code>, and/or <code>.d</code> are declared, will return a <code>pibble</code> set in that way.</p></td>
    </tr>
    </table>

    <h2 class="hasAnchor" id="details"><a class="anchor" href="#details"></a>Details</h2>

    <p>To apply <code>mutate_cascade()</code> to non-panel data and without any grouping (perhaps to mimic standard Stata <code>replace</code> functionality), add a variable to your data indicating the order you'd like <code>mutate</code> performed in (perhaps using <code><a href='https://dplyr.tidyverse.org/reference/ranking.html'>dplyr::row_number()</a></code>) and <code>.t</code> to that new variable.</p>

    <h2 class="hasAnchor" id="examples"><a class="anchor" href="#examples"></a>Examples</h2>
    <pre class="examples"><div class='input'>
<span class='fu'><a href='https://rdrr.io/r/utils/data.html'>data</a></span>(<span class='no'>Scorecard</span>)
<span class='co'># I'd like to build a decaying function that remembers previous earnings but at a declining rate</span>
<span class='co'># Let's only use nonmissing earnings</span>
<span class='co'># And let's say we're only interested in four-year colleges in Colorado</span>
<span class='co'># (mutate_cascade + tlag can be very slow so we're working with a smaller sample)</span>
<span class='no'>Scorecard</span> <span class='kw'>&lt;-</span> <span class='no'>Scorecard</span> <span class='kw'>%&gt;%</span>
  <span class='kw pkg'>dplyr</span><span class='kw ns'>::</span><span class='fu'><a href='https://dplyr.tidyverse.org/reference/filter.html'>filter</a></span>(
    !<span class='fu'><a href='https://rdrr.io/r/base/NA.html'>is.na</a></span>(<span class='no'>earnings_med</span>),
    <span class='no'>pred_degree_awarded_ipeds</span> <span class='kw'>==</span> <span class='fl'>3</span>,
    <span class='no'>state_abbr</span> <span class='kw'>==</span> <span class='st'>"CO"</span>
  ) <span class='kw'>%&gt;%</span>
  <span class='co'># And declare the panel structure</span>
  <span class='fu'><a href='as_pibble.html'>as_pibble</a></span>(<span class='kw'>.i</span> <span class='kw'>=</span> <span class='no'>unitid</span>, <span class='kw'>.t</span> <span class='kw'>=</span> <span class='no'>year</span>)
<span class='no'>Scorecard</span> <span class='kw'>&lt;-</span> <span class='no'>Scorecard</span> <span class='kw'>%&gt;%</span>
  <span class='co'># Almost all instances involve a variable being set to a function of a lag of itself</span>
  <span class='co'># we don't want to overwrite so let's make another</span>
  <span class='co'># Note that earnings_med is an integer -</span>
  <span class='co'># but we're about to make non-integer decay function, so call it a double!</span>
  <span class='kw pkg'>dplyr</span><span class='kw ns'>::</span><span class='fu'><a href='https://dplyr.tidyverse.org/reference/mutate.html'>mutate</a></span>(<span class='kw'>decay_earnings</span> <span class='kw'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/double.html'>as.double</a></span>(<span class='no'>earnings_med</span>)) <span class='kw'>%&gt;%</span>
  <span class='co'># Now we can cascade</span>
  <span class='fu'>mutate_cascade</span>(
    <span class='kw'>decay_earnings</span> <span class='kw'>=</span> <span class='no'>decay_earnings</span> +
      <span class='fl'>.5</span> * <span class='fu'><a href='tlag.html'>tlag</a></span>(<span class='no'>decay_earnings</span>, <span class='kw'>.quick</span> <span class='kw'>=</span> <span class='fl'>TRUE</span>)
  )</div></pre>
  </div>
  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">
    <nav id="toc" data-toggle="toc" class="sticky-top">
      <h2 data-toc-skip>Contents</h2>
    </nav>
  </div>
</div>


      <footer>
      <div class="copyright">
  <p>Developed by Nick Huntington-Klein, Philip Khor.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.5.1.</p>
</div>

      </footer>
   </div>

  


  </body>
</html>



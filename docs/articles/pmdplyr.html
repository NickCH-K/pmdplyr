<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>pmdplyr: Panel Maneuvers in dplyr • pmdplyr</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha256-916EbMg70RQy9LHiGkXzG8hSg9EdNy97GazNG/aiY1w=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha256-U5ZEeKfGNOja007MMD3YBI0A3OSZOQbeG6z2f2Y0hu8=" crossorigin="anonymous"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.7.1/css/all.min.css" integrity="sha256-nAmazAk6vS34Xqo0BSrTb+abbtFlgsFK7NKSi6o7Y78=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.7.1/css/v4-shims.min.css" integrity="sha256-6qHlizsOWFskGlwVOKuns+D1nB6ssZrHQrNj1wGplHc=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.4/clipboard.min.js" integrity="sha256-FiZwavyI2V6+EXO1U+xzLG3IKldpiTFf3153ea9zikQ=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.9.4/headroom.min.js" integrity="sha256-DJFC1kqIhelURkuza0AvYal5RxMtpzLjFhsnVIeuk+U=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.9.4/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="pmdplyr: Panel Maneuvers in dplyr">
<meta property="og:description" content="">
<meta name="twitter:card" content="summary">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">pmdplyr</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.2.1</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fas fa fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../articles/pmdplyr.html">Get started</a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/NickCH-K/pmdplyr">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1>pmdplyr: Panel Maneuvers in dplyr</h1>
                        <h4 class="author">Nick Huntington-Klein, Philip Khor</h4>
            
            <h4 class="date">2019-08-12</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/NickCH-K/pmdplyr/blob/master/vignettes/pmdplyr.Rmd"><code>vignettes/pmdplyr.Rmd</code></a></small>
      <div class="hidden name"><code>pmdplyr.Rmd</code></div>

    </div>

    
    
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1-1" title="1"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span>(pmdplyr)</a></code></pre></div>
<p>The <code>pmdplyr</code> package is an extension to <code>dplyr</code> designed for cleaning and managing panel and hierarchical data. It contains variations on the <code><a href="https://dplyr.tidyverse.org/reference/mutate.html">dplyr::mutate()</a></code> and <code><a href="https://dplyr.tidyverse.org/reference/join.html">dplyr::join()</a></code> functions that address common panel data needs, and contains functions for managing and cleaning panel data.</p>
<p>Unlike other panel data packages, functions in <code>pmdplyr</code> are all designed to work even if there is more than one observation per individual per period. This comes in handy if each individual is observed multiple times per period - for example, multiple classes per student per term; or if you have hierarchical data - for example, multiple companies per country.</p>
<p><code>pmdplyr</code> contains a long list of functions for working with panel data, described below.</p>
<hr>
<div id="pibble" class="section level1">
<h1 class="hasAnchor">
<a href="#pibble" class="anchor"></a>pibble</h1>
<p>The <code>pibble</code> data type is a <code>tibble</code> data frame with additional attributes <code>.i</code>, which is a set of variables in the <code>pibble</code> that identifies individuals, <code>.t</code>, which is a variable in the <code>pibble</code> that indentifies the time index, and <code>.d</code>, which identifies the gap between periods of <code>.t</code>. If the gap between time periods doesn’t matter and any consecutive time periods should be treated as consecutive, set <code>.d = 0</code>.</p>
<p><code>pibble</code> status will be maintained if the <code>pibble</code> is modified using functions from <code>pmdplyr</code> or <code>dplyr</code> (unless you use those functions in a way that drops or renames the <code>.i</code> or <code>.t</code> variables, in which case <code>pibble</code> status will be lost). Other data manipulation functions may remove <code>pibble</code> status, requiring it to be re-declared as a <code>pibble</code>.</p>
<p>Most functions in <code>pmdplyr</code> will allow you to declare <code>.i</code> and <code>.t</code> in the function itself. But if a <code>pibble</code> is passed in via a <code>dplyr</code> verb, there is no need.</p>
<div id="pibble-and-as_pibble" class="section level2">
<h2 class="hasAnchor">
<a href="#pibble-and-as_pibble" class="anchor"></a>pibble() and as_pibble()</h2>
<p><code>pibble</code>s can be declared in two main ways: raw, via <code><a href="../reference/pibble.html">pibble()</a></code>:</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb2-1" title="1"><span class="kw"><a href="../reference/pibble.html">pibble</a></span>(...,</a>
<a class="sourceLine" id="cb2-2" title="2">  <span class="dt">.i =</span> <span class="ot">NULL</span>,</a>
<a class="sourceLine" id="cb2-3" title="3">  <span class="dt">.t =</span> <span class="ot">NULL</span>,</a>
<a class="sourceLine" id="cb2-4" title="4">  <span class="dt">.d =</span> <span class="dv">1</span>,</a>
<a class="sourceLine" id="cb2-5" title="5">  <span class="dt">.uniqcheck =</span> <span class="ot">FALSE</span></a>
<a class="sourceLine" id="cb2-6" title="6">)</a></code></pre></div>
<p>or by transforming an existing <code>data.frame</code>, <code>list</code>, or <code>tbl_df</code> using <code><a href="../reference/as_pibble.html">as_pibble()</a></code>:</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb3-1" title="1"><span class="kw"><a href="../reference/as_pibble.html">as_pibble</a></span>(x,</a>
<a class="sourceLine" id="cb3-2" title="2">  <span class="dt">.i =</span> <span class="ot">NULL</span>,</a>
<a class="sourceLine" id="cb3-3" title="3">  <span class="dt">.t =</span> <span class="ot">NULL</span>,</a>
<a class="sourceLine" id="cb3-4" title="4">  <span class="dt">.d =</span> <span class="dv">1</span>,</a>
<a class="sourceLine" id="cb3-5" title="5">  <span class="dt">.uniqcheck =</span> <span class="ot">FALSE</span>,</a>
<a class="sourceLine" id="cb3-6" title="6">  ...</a>
<a class="sourceLine" id="cb3-7" title="7">)</a></code></pre></div>
<p>Both functions work exactly as <code><a href="https://tibble.tidyverse.org/reference/tibble.html">tibble::tibble()</a></code> and <code><a href="https://tibble.tidyverse.org/reference/as_tibble.html">tibble::as_tibble()</a></code> do, except that they also take the arguments <code>.i</code>, <code>.t</code>, and <code>.d</code>, with <code>.i</code> and <code>.t</code> accepting either unquoted or quoted variable names. If you’d like your <code>pibble</code> checked to see if <code>.i</code> and <code>.t</code> uniquely identify your observations, set <code>.uniqcheck = TRUE</code>. It will do this automatically the first time in each R session you create a <code>pibble</code>, but if you’d like it to keep doing it, use <code>uniqcheck</code>.</p>
<p>As a side bonus, you can check if the variables <code>a, b, c</code> uniquely identify the observations in data set <code>d</code> by running <code><a href="../reference/as_pibble.html">as_pibble(d, .i = c(a, b, c), .uniqcheck = TRUE)</a></code>. No warning? It’s uniquely identified!</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb4-1" title="1"><span class="co"># .d = 1 by default, so in this data,</span></a>
<a class="sourceLine" id="cb4-2" title="2"><span class="co"># a = 1, b = 3 comes one period after a = 1, b = 2.</span></a>
<a class="sourceLine" id="cb4-3" title="3">basic_pibble &lt;-<span class="st"> </span><span class="kw"><a href="../reference/pibble.html">pibble</a></span>(</a>
<a class="sourceLine" id="cb4-4" title="4">  <span class="dt">a =</span> <span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">2</span>, <span class="dv">2</span>),</a>
<a class="sourceLine" id="cb4-5" title="5">  <span class="dt">b =</span> <span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">3</span>, <span class="dv">2</span>, <span class="dv">3</span>, <span class="dv">3</span>),</a>
<a class="sourceLine" id="cb4-6" title="6">  <span class="dt">c =</span> <span class="dv">1</span><span class="op">:</span><span class="dv">6</span>,</a>
<a class="sourceLine" id="cb4-7" title="7">  <span class="dt">.i =</span> a,</a>
<a class="sourceLine" id="cb4-8" title="8">  <span class="dt">.t =</span> b</a>
<a class="sourceLine" id="cb4-9" title="9">)</a>
<a class="sourceLine" id="cb4-10" title="10"></a>
<a class="sourceLine" id="cb4-11" title="11"><span class="kw"><a href="https://rdrr.io/r/utils/data.html">data</a></span>(SPrail)</a>
<a class="sourceLine" id="cb4-12" title="12"><span class="co"># In SPrail, insert_date does not imply regular gaps between</span></a>
<a class="sourceLine" id="cb4-13" title="13"><span class="co"># time periods, so we set .d = 0</span></a>
<a class="sourceLine" id="cb4-14" title="14">declared_pibble &lt;-<span class="st"> </span><span class="kw"><a href="../reference/as_pibble.html">as_pibble</a></span>(SPrail,</a>
<a class="sourceLine" id="cb4-15" title="15">  <span class="dt">.i =</span> <span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(origin, destination),</a>
<a class="sourceLine" id="cb4-16" title="16">  <span class="dt">.t =</span> insert_date,</a>
<a class="sourceLine" id="cb4-17" title="17">  <span class="dt">.d =</span> <span class="dv">0</span></a>
<a class="sourceLine" id="cb4-18" title="18">)</a></code></pre></div>
</div>
<div id="panel_convert" class="section level2">
<h2 class="hasAnchor">
<a href="#panel_convert" class="anchor"></a>panel_convert()</h2>
<p><code>pmdplyr</code> also has the function <code><a href="../reference/panel_convert.html">panel_convert()</a></code> which allows you to convert between different popular R panel data objects, including <code>pibble</code>. This can come in handy for creating <code>pibbles</code>, or exporting your cleaned <code>pibble</code> to use with a package that does panel data <em>analysis</em> (which <code>pmdplyr</code> does not):</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb5-1" title="1"><span class="kw"><a href="../reference/panel_convert.html">panel_convert</a></span>(</a>
<a class="sourceLine" id="cb5-2" title="2">  data,</a>
<a class="sourceLine" id="cb5-3" title="3">  to,</a>
<a class="sourceLine" id="cb5-4" title="4">  ...</a>
<a class="sourceLine" id="cb5-5" title="5">)</a></code></pre></div>
<p>Where <code>data</code> is a panel data object, either <code>pibble</code>, <code>tsibble</code>, <code>pdata.frame</code>, or <code>panel_data</code>, and <code>to</code> is the type of object you’d like returned, which you can refer to by object name, object class, or package name: get a <code>pibble</code> with <code>"pmdplyr"</code>, <code>"pibble"</code>, or <code>"tbl_pb"</code>, a <code>tsibble</code> with <code>"tsibble"</code> or <code>"tbl_ts"</code>, a <code>pdata.frame</code> with <code>"plm"</code> or <code>"pdata.frame"</code>, or a <code>panel_data</code> with <code>"panelr"</code> or <code>"panel_data"</code>. <code>...</code> sends additional arguments to the functions used to declare those objects.</p>
<p>When using <code>panel_convert</code>, be aware that any grouping will be lost, and you must have the relevant package of your <code>to</code> option installed (<code>tsibble</code>, <code>plm</code>, or <code>panelr</code>). When your <code>data</code> object is a <code>pdata.frame</code>, it is recommended to also have <code>sjlabelled</code> installed.</p>
<p>All valid objects of the non-<code>pibble</code> types can be converted to <code>pibbles</code>, but the reverse is not true, since <code>pibble</code> does not enforce some strict requirements that other types do:</p>
<table class="table">
<thead><tr class="header">
<th>Feature/Requirement</th>
<th><code>pibble</code></th>
<th><code>tsibble</code></th>
<th><code>pdata.frame</code></th>
<th><code>panel_data</code></th>
</tr></thead>
<tbody>
<tr class="odd">
<td>ID</td>
<td><code>.i</code></td>
<td><code>key</code></td>
<td><code>index[1]</code></td>
<td><code>id</code></td>
</tr>
<tr class="even">
<td>Time</td>
<td><code>.t</code></td>
<td><code>index</code></td>
<td><code>index[2]</code></td>
<td><code>wave</code></td>
</tr>
<tr class="odd">
<td>Gap control</td>
<td><code>.d</code></td>
<td><code>regular</code></td>
<td>No</td>
<td>No</td>
</tr>
<tr class="even">
<td>ID must exist</td>
<td>No</td>
<td>No</td>
<td>Yes</td>
<td>Yes</td>
</tr>
<tr class="odd">
<td>Time must exist</td>
<td>No</td>
<td>Yes</td>
<td>Yes</td>
<td>Yes[1]</td>
</tr>
<tr class="even">
<td>Only one ID variable[2]</td>
<td>No</td>
<td>No</td>
<td>Yes</td>
<td>Yes</td>
</tr>
<tr class="odd">
<td>Unique identification</td>
<td>No</td>
<td>Yes</td>
<td>No[3]</td>
<td>No[3]</td>
</tr>
</tbody>
</table>
<p>[1] <code>pdata.frame</code> does not require that time be provided, but if not provided will create it based on original ordering of the data. The <code>pdata.frame</code> option to set <code>index</code> equal to an integer for a balanced panel and have it figure out the rest by itself is not supported.</p>
<p>[2] Use <code><a href="../reference/id_variable.html">id_variable()</a></code> (described below) to generate a single ID variable from multiple if one is required.</p>
<p>[3] <code>pdata.frame</code> and <code>panel_data</code> do not require that ID and time uniquely identify the observations on declaring the data, but functions in these packages may not work correctly without unique identification.</p>
<p>In addition to the above, be aware that the different packages have different requirements on which variable classes can be Time variables. <code><a href="../reference/time_variable.html">time_variable()</a></code> (described below) can build an integer variable that will work in all packages.</p>
<hr>
</div>
</div>
<div id="id-and-time-variables" class="section level1">
<h1 class="hasAnchor">
<a href="#id-and-time-variables" class="anchor"></a>ID and Time Variables</h1>
<p>Any panel data dataset is defined by ID variable(s) (<code>.i</code>) that indicate the individual person/firm/country/etc. you’re talking about, and a time variable (<code>.t</code>) that tell you when the observation in question was recorded.</p>
<p>While <code>pmdplyr</code> allows multiple ID variables, many panel data packages only allow one. <code><a href="../reference/id_variable.html">id_variable()</a></code> allows you to turn multiple ID variables into a single variable.</p>
<p>Many panel data packages, including <code>pmdplyr</code>, prefer a time variable that is an integer, so that the difference between each period is 1 (or <code>.d</code> in <code>pmdplyr</code>’s case). The function <code><a href="../reference/time_variable.html">time_variable()</a></code> can help you generate an integer time variable from a <code>Date</code>-class variable, or from one or more variables containing, for example, year and month.</p>
<div id="id_variable" class="section level2">
<h2 class="hasAnchor">
<a href="#id_variable" class="anchor"></a>id_variable()</h2>
<p><code><a href="../reference/id_variable.html">id_variable()</a></code> syntax follows:</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb6-1" title="1"><span class="kw"><a href="../reference/id_variable.html">id_variable</a></span>(...,</a>
<a class="sourceLine" id="cb6-2" title="2">  <span class="dt">.method =</span> <span class="st">"number"</span>,</a>
<a class="sourceLine" id="cb6-3" title="3">  <span class="dt">.minwidth =</span> <span class="ot">FALSE</span></a>
<a class="sourceLine" id="cb6-4" title="4">)</a></code></pre></div>
<p>where <code>...</code> is the set of identity variables that you want to combine into a single one (or, potentially, a single variable you’d like to encode numerically).</p>
<p><code>.method</code> describes the way in which you’d like the variable encoded:</p>
<ul>
<li>
<code>.method = number</code> assigns consecutive numeric codes in the original order they appear in the data.</li>
<li>
<code>.method = random</code> assigns numeric codes from <code>0</code> to <code>10*N</code> (where <code>N</code> is the number of codes to be assigned) in a random order, so it will be more difficult to uncover the original identity variables.</li>
<li>
<code>.method = character</code> preserves all original information and combines the variables together into a string, adding spacing to ensure uniqueness. Set <code>.minwidth = TRUE</code> to remove the spacing, although this may lead to non-uniqueness in some cases.</li>
</ul>
<div class="sourceCode" id="cb7"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb7-1" title="1">df &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span>(</a>
<a class="sourceLine" id="cb7-2" title="2">  <span class="dt">country =</span> <span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(</a>
<a class="sourceLine" id="cb7-3" title="3">    <span class="st">"US"</span>, <span class="st">"US"</span>, <span class="st">"US"</span>, <span class="st">"US"</span>,</a>
<a class="sourceLine" id="cb7-4" title="4">    <span class="st">"GBR"</span>, <span class="st">"GBR"</span>, <span class="st">"GBR"</span>, <span class="st">"GBR"</span></a>
<a class="sourceLine" id="cb7-5" title="5">  ),</a>
<a class="sourceLine" id="cb7-6" title="6">  <span class="dt">city =</span> <span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(</a>
<a class="sourceLine" id="cb7-7" title="7">    <span class="st">"NYC"</span>, <span class="st">"NYC"</span>, <span class="st">"Cambridge"</span>, <span class="st">"NYC"</span>,</a>
<a class="sourceLine" id="cb7-8" title="8">    <span class="st">"Cambridge"</span>, <span class="st">"London"</span>, <span class="st">"Manchester"</span>, <span class="st">"Manchester"</span></a>
<a class="sourceLine" id="cb7-9" title="9">  )</a>
<a class="sourceLine" id="cb7-10" title="10">) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb7-11" title="11"><span class="st">  </span><span class="kw">mutate</span>(</a>
<a class="sourceLine" id="cb7-12" title="12">    <span class="dt">numeric_ID =</span> <span class="kw"><a href="../reference/id_variable.html">id_variable</a></span>(country, city),</a>
<a class="sourceLine" id="cb7-13" title="13">    <span class="dt">random_ID =</span> <span class="kw"><a href="../reference/id_variable.html">id_variable</a></span>(country, city, <span class="dt">.method =</span> <span class="st">"random"</span>),</a>
<a class="sourceLine" id="cb7-14" title="14">    <span class="dt">char_ID =</span> <span class="kw"><a href="../reference/id_variable.html">id_variable</a></span>(country, city, <span class="dt">.method =</span> <span class="st">"character"</span>)</a>
<a class="sourceLine" id="cb7-15" title="15">  )</a>
<a class="sourceLine" id="cb7-16" title="16"></a>
<a class="sourceLine" id="cb7-17" title="17">df</a>
<a class="sourceLine" id="cb7-18" title="18"><span class="co">#&gt;   country       city numeric_ID random_ID           char_ID</span></a>
<a class="sourceLine" id="cb7-19" title="19"><span class="co">#&gt; 1      US        NYC          1        46 |US|.|NYC|.......</span></a>
<a class="sourceLine" id="cb7-20" title="20"><span class="co">#&gt; 2      US        NYC          1        46 |US|.|NYC|.......</span></a>
<a class="sourceLine" id="cb7-21" title="21"><span class="co">#&gt; 3      US  Cambridge          2        11 |US|.|Cambridge|.</span></a>
<a class="sourceLine" id="cb7-22" title="22"><span class="co">#&gt; 4      US        NYC          1        46 |US|.|NYC|.......</span></a>
<a class="sourceLine" id="cb7-23" title="23"><span class="co">#&gt; 5     GBR  Cambridge          3        14 |GBR||Cambridge|.</span></a>
<a class="sourceLine" id="cb7-24" title="24"><span class="co">#&gt; 6     GBR     London          4        42 |GBR||London|....</span></a>
<a class="sourceLine" id="cb7-25" title="25"><span class="co">#&gt; 7     GBR Manchester          5        39 |GBR||Manchester|</span></a>
<a class="sourceLine" id="cb7-26" title="26"><span class="co">#&gt; 8     GBR Manchester          5        39 |GBR||Manchester|</span></a></code></pre></div>
</div>
<div id="time_variable" class="section level2">
<h2 class="hasAnchor">
<a href="#time_variable" class="anchor"></a>time_variable()</h2>
<p><code><a href="../reference/time_variable.html">time_variable()</a></code> syntax follows:</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb8-1" title="1"><span class="kw"><a href="../reference/time_variable.html">time_variable</a></span>(...,</a>
<a class="sourceLine" id="cb8-2" title="2">  <span class="dt">.method =</span> <span class="st">"present"</span>,</a>
<a class="sourceLine" id="cb8-3" title="3">  <span class="dt">.datepos =</span> <span class="ot">NA</span>,</a>
<a class="sourceLine" id="cb8-4" title="4">  <span class="dt">.start =</span> <span class="dv">1</span>,</a>
<a class="sourceLine" id="cb8-5" title="5">  <span class="dt">.skip =</span> <span class="ot">NA</span>,</a>
<a class="sourceLine" id="cb8-6" title="6">  <span class="dt">.breaks =</span> <span class="ot">NA</span>,</a>
<a class="sourceLine" id="cb8-7" title="7">  <span class="dt">.turnover =</span> <span class="ot">NA</span>,</a>
<a class="sourceLine" id="cb8-8" title="8">  <span class="dt">.turnover_start =</span> <span class="ot">NA</span></a>
<a class="sourceLine" id="cb8-9" title="9">)</a></code></pre></div>
<p>Where <code>...</code> is the set of variables that you want to combine into a single, <code>integer</code>-class time variable. The rest of the options determine how the variable(s) will be read or transformed; the need for each varies depending on the structure of the original data and which <code>.method</code> is used.</p>
<p><code>.method</code> can take the values:</p>
<ul>
<li>
<code>.method = "present"</code> will assume that, even if each individual may have some missing periods, each period is present in your data <em>somewhere</em>, and so simply numbers, in order, all the time periods observed in the data.</li>
<li>
<code>.method = "year"</code> can be used with a single <code>Date</code>/<code>POSIX</code>/etc.-type variable (anything that allows <code><a href="http://lubridate.tidyverse.org/reference/date.html">lubridate::date()</a></code>) and will extract the year from it. Or, use it with a character or numeric variable and indicate with <code>.datepos</code> the character/digit positions that hold the year in YY or YYYY format. If combined with <code>.breaks</code> or <code>.skip</code>, will instead set the earliest year in the data to 1 rather than returning the actual year.</li>
<li>
<code>.method = "month"</code> can be used with a single <code>Date</code>/<code>POSIX</code>/etc.-type variable (anything that allows <code><a href="http://lubridate.tidyverse.org/reference/date.html">lubridate::date()</a></code>). It will give the earliest-observed month in the data set a value of <code>1</code>, and will increment from there. Or, use it with a character or numeric variable and indicate with <code>.datepos</code> the character/digit positions that hold the year and month in YYMM or YYYYMM format (note that if your variable is in MMYYYY format, for example, you can just give a <code>.datepos</code> argument like <code><a href="https://rdrr.io/r/base/c.html">c(3:6,1:2)</a></code>). Months turn over on the <code>.start</code> day of the month, which is by default 1.</li>
<li>
<code>.method = "week"</code> can be used with a single <code>Date</code>/<code>POSIX</code>/etc.-type variable (anything that allows <code><a href="http://lubridate.tidyverse.org/reference/date.html">lubridate::date()</a></code>). It will give the earliest-observed week in the data set a value of <code>1</code>, and will increment from there. Weeks turn over on the <code>.start</code> day, which is by default 1 (Monday). Note that this method always starts weeks on the same day of the week, which is different from standard <code>lubridate</code> procedure of counting sets of 7 days starting from January 1.</li>
<li>
<code>.method = "day"</code> can be used with a single <code>Date</code>/<code>POSIX</code>/etc.-type variable (anything that allows <code><a href="http://lubridate.tidyverse.org/reference/date.html">lubridate::date()</a></code>). It will give the earliest-observed day in the data set a value of <code>1</code>, and increment from there. Or, use it with a character or numeric variable and indicate with <code>.datepos</code> the character/digit positions that hold the year and month in YYMMDD or YYYYMMDD format. To skip certain days of the week, such as weekends, use the <code>.skip</code> option.</li>
<li>
<code>.method = "turnover"</code> can be used when you have more than one variable in variable and they are all numeric nonnegative integers. Set the <code>.turnover</code> option to indicate the highest value each variable takes before it starts over, and set <code>.turnover_start</code> to indicate what value it takes when it starts over. Cannot be combined with <code>.skip</code> or <code>.breaks</code>. Doesn’t work with any variable for which the turnover values change, i.e. it doesn’t play well with days-in-month - if you’d like to do something like year-month-day-hour, I recommend running <code>.method="day"</code> once with just the year-month-day variable, and then taking the result and combining <em>that</em> with hour in <code>.method = "turnover"</code>.</li>
</ul>
<div class="sourceCode" id="cb9"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb9-1" title="1"><span class="kw"><a href="https://rdrr.io/r/utils/data.html">data</a></span>(SPrail)</a>
<a class="sourceLine" id="cb9-2" title="2"></a>
<a class="sourceLine" id="cb9-3" title="3"><span class="co"># Since we have a date variable, we can easily create integers that increment for each</span></a>
<a class="sourceLine" id="cb9-4" title="4"><span class="co"># year, or for each month, etc.</span></a>
<a class="sourceLine" id="cb9-5" title="5"><span class="co"># Likely we'd only really need one of these four, depending on our purposes</span></a>
<a class="sourceLine" id="cb9-6" title="6">SPrail &lt;-<span class="st"> </span>SPrail <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb9-7" title="7"><span class="st">  </span>dplyr<span class="op">::</span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span>(</a>
<a class="sourceLine" id="cb9-8" title="8">    <span class="dt">year_time_id =</span> <span class="kw"><a href="../reference/time_variable.html">time_variable</a></span>(insert_date, <span class="dt">.method =</span> <span class="st">"year"</span>),</a>
<a class="sourceLine" id="cb9-9" title="9">    <span class="dt">month_time_id =</span> <span class="kw"><a href="../reference/time_variable.html">time_variable</a></span>(insert_date, <span class="dt">.method =</span> <span class="st">"month"</span>),</a>
<a class="sourceLine" id="cb9-10" title="10">    <span class="dt">week_time_id =</span> <span class="kw"><a href="../reference/time_variable.html">time_variable</a></span>(insert_date, <span class="dt">.method =</span> <span class="st">"week"</span>),</a>
<a class="sourceLine" id="cb9-11" title="11">    <span class="dt">day_time_id =</span> <span class="kw"><a href="../reference/time_variable.html">time_variable</a></span>(insert_date, <span class="dt">.method =</span> <span class="st">"day"</span>)</a>
<a class="sourceLine" id="cb9-12" title="12">  )</a>
<a class="sourceLine" id="cb9-13" title="13"></a>
<a class="sourceLine" id="cb9-14" title="14"><span class="co"># Let's see what we've got</span></a>
<a class="sourceLine" id="cb9-15" title="15">SPrail <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb9-16" title="16"><span class="st">  </span><span class="kw">select</span>(insert_date, <span class="kw">ends_with</span>(<span class="st">"time_id"</span>)) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb9-17" title="17"><span class="st">  </span><span class="kw"><a href="https://rdrr.io/r/utils/head.html">head</a></span>()</a>
<a class="sourceLine" id="cb9-18" title="18"><span class="co">#&gt; # A tibble: 6 x 5</span></a>
<a class="sourceLine" id="cb9-19" title="19"><span class="co">#&gt;   insert_date         year_time_id month_time_id week_time_id day_time_id</span></a>
<a class="sourceLine" id="cb9-20" title="20"><span class="co">#&gt;   &lt;dttm&gt;                     &lt;int&gt;         &lt;int&gt;        &lt;int&gt;       &lt;int&gt;</span></a>
<a class="sourceLine" id="cb9-21" title="21"><span class="co">#&gt; 1 2019-04-12 20:17:04         2019             1            1           2</span></a>
<a class="sourceLine" id="cb9-22" title="22"><span class="co">#&gt; 2 2019-04-16 09:33:08         2019             1            2           6</span></a>
<a class="sourceLine" id="cb9-23" title="23"><span class="co">#&gt; 3 2019-05-08 09:04:07         2019             2            5          28</span></a>
<a class="sourceLine" id="cb9-24" title="24"><span class="co">#&gt; 4 2019-04-16 06:21:42         2019             1            2           6</span></a>
<a class="sourceLine" id="cb9-25" title="25"><span class="co">#&gt; 5 2019-05-02 07:03:34         2019             2            4          22</span></a>
<a class="sourceLine" id="cb9-26" title="26"><span class="co">#&gt; 6 2019-04-13 06:03:43         2019             1            1           3</span></a>
<a class="sourceLine" id="cb9-27" title="27"></a>
<a class="sourceLine" id="cb9-28" title="28"><span class="co"># Perhaps I'd like quarterly data</span></a>
<a class="sourceLine" id="cb9-29" title="29"><span class="co"># (although in this case there are only two months, not much variation there)</span></a>
<a class="sourceLine" id="cb9-30" title="30">SPrail &lt;-<span class="st"> </span>SPrail <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb9-31" title="31"><span class="st">  </span>dplyr<span class="op">::</span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span>(<span class="dt">quarter_time_id =</span> <span class="kw"><a href="../reference/time_variable.html">time_variable</a></span>(insert_date,</a>
<a class="sourceLine" id="cb9-32" title="32">    <span class="dt">.method =</span> <span class="st">"month"</span>,</a>
<a class="sourceLine" id="cb9-33" title="33">    <span class="dt">.breaks =</span> <span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="dv">1</span>, <span class="dv">4</span>, <span class="dv">7</span>, <span class="dv">10</span>)</a>
<a class="sourceLine" id="cb9-34" title="34">  ))</a>
<a class="sourceLine" id="cb9-35" title="35"><span class="co"># Should line up properly with month</span></a>
<a class="sourceLine" id="cb9-36" title="36">SPrail <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb9-37" title="37"><span class="st">  </span><span class="kw">count</span>(month_time_id, quarter_time_id)</a>
<a class="sourceLine" id="cb9-38" title="38"><span class="co">#&gt; # A tibble: 2 x 3</span></a>
<a class="sourceLine" id="cb9-39" title="39"><span class="co">#&gt;   month_time_id quarter_time_id     n</span></a>
<a class="sourceLine" id="cb9-40" title="40"><span class="co">#&gt;           &lt;int&gt;           &lt;int&gt; &lt;int&gt;</span></a>
<a class="sourceLine" id="cb9-41" title="41"><span class="co">#&gt; 1             1               1  1633</span></a>
<a class="sourceLine" id="cb9-42" title="42"><span class="co">#&gt; 2             2               1   367</span></a>
<a class="sourceLine" id="cb9-43" title="43"></a>
<a class="sourceLine" id="cb9-44" title="44"><span class="co"># Maybe I'd like Monday to come immediately after Friday!</span></a>
<a class="sourceLine" id="cb9-45" title="45">SPrail &lt;-<span class="st"> </span>SPrail <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb9-46" title="46"><span class="st">  </span>dplyr<span class="op">::</span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span>(<span class="dt">weekday_time_id =</span> <span class="kw"><a href="../reference/time_variable.html">time_variable</a></span>(insert_date,</a>
<a class="sourceLine" id="cb9-47" title="47">    <span class="dt">.method =</span> <span class="st">"day"</span>,</a>
<a class="sourceLine" id="cb9-48" title="48">    <span class="dt">.skip =</span> <span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="dv">6</span>, <span class="dv">7</span>)</a>
<a class="sourceLine" id="cb9-49" title="49">  ))</a>
<a class="sourceLine" id="cb9-50" title="50"></a>
<a class="sourceLine" id="cb9-51" title="51"><span class="co"># Perhaps I'm interested in ANY time period in the data and just want to enumerate them in order</span></a>
<a class="sourceLine" id="cb9-52" title="52">SPrail &lt;-<span class="st"> </span>SPrail <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb9-53" title="53"><span class="st">  </span>dplyr<span class="op">::</span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span>(<span class="dt">any_present_time_id =</span> <span class="kw"><a href="../reference/time_variable.html">time_variable</a></span>(insert_date,</a>
<a class="sourceLine" id="cb9-54" title="54">    <span class="dt">.method =</span> <span class="st">"present"</span></a>
<a class="sourceLine" id="cb9-55" title="55">  ))</a>
<a class="sourceLine" id="cb9-56" title="56"></a>
<a class="sourceLine" id="cb9-57" title="57"><span class="co"># Note the weekday_time_id NAs - these are weekends! We told it to skip those.</span></a>
<a class="sourceLine" id="cb9-58" title="58"><span class="kw"><a href="https://rdrr.io/r/utils/head.html">head</a></span>(SPrail <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">select</span>(insert_date, day_time_id, weekday_time_id, any_present_time_id))</a>
<a class="sourceLine" id="cb9-59" title="59"><span class="co">#&gt; # A tibble: 6 x 4</span></a>
<a class="sourceLine" id="cb9-60" title="60"><span class="co">#&gt;   insert_date         day_time_id weekday_time_id any_present_time_id</span></a>
<a class="sourceLine" id="cb9-61" title="61"><span class="co">#&gt;   &lt;dttm&gt;                    &lt;int&gt;           &lt;int&gt;               &lt;int&gt;</span></a>
<a class="sourceLine" id="cb9-62" title="62"><span class="co">#&gt; 1 2019-04-12 20:17:04           2              NA                  96</span></a>
<a class="sourceLine" id="cb9-63" title="63"><span class="co">#&gt; 2 2019-04-16 09:33:08           6               4                 461</span></a>
<a class="sourceLine" id="cb9-64" title="64"><span class="co">#&gt; 3 2019-05-08 09:04:07          28              20                1899</span></a>
<a class="sourceLine" id="cb9-65" title="65"><span class="co">#&gt; 4 2019-04-16 06:21:42           6               4                 446</span></a>
<a class="sourceLine" id="cb9-66" title="66"><span class="co">#&gt; 5 2019-05-02 07:03:34          22              16                1670</span></a>
<a class="sourceLine" id="cb9-67" title="67"><span class="co">#&gt; 6 2019-04-13 06:03:43           3              NA                 130</span></a>
<a class="sourceLine" id="cb9-68" title="68"></a>
<a class="sourceLine" id="cb9-69" title="69"><span class="co"># Maybe instead of being given a nice time variable, I was given it in string form</span></a>
<a class="sourceLine" id="cb9-70" title="70">SPrail &lt;-<span class="st"> </span>SPrail <span class="op">%&gt;%</span><span class="st"> </span>dplyr<span class="op">::</span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span>(<span class="dt">time_string =</span> <span class="kw"><a href="https://rdrr.io/r/base/character.html">as.character</a></span>(insert_date))</a>
<a class="sourceLine" id="cb9-71" title="71"><span class="co"># As long as the character positions are consistent we can still use it</span></a>
<a class="sourceLine" id="cb9-72" title="72">SPrail &lt;-<span class="st"> </span>SPrail <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb9-73" title="73"><span class="st">  </span>dplyr<span class="op">::</span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span>(<span class="dt">day_from_string_id =</span> <span class="kw"><a href="../reference/time_variable.html">time_variable</a></span>(time_string,</a>
<a class="sourceLine" id="cb9-74" title="74">    <span class="dt">.method =</span> <span class="st">"day"</span>,</a>
<a class="sourceLine" id="cb9-75" title="75">    <span class="dt">.datepos =</span> <span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="dv">3</span>, <span class="dv">4</span>, <span class="dv">6</span>, <span class="dv">7</span>, <span class="dv">9</span>, <span class="dv">10</span>)</a>
<a class="sourceLine" id="cb9-76" title="76">  ))</a>
<a class="sourceLine" id="cb9-77" title="77"><span class="co"># Results are identical from using the actual Date variable</span></a>
<a class="sourceLine" id="cb9-78" title="78"><span class="kw"><a href="https://rdrr.io/r/stats/cor.html">cor</a></span>(SPrail<span class="op">$</span>day_time_id, SPrail<span class="op">$</span>day_from_string_id)</a>
<a class="sourceLine" id="cb9-79" title="79"><span class="co">#&gt; [1] 1</span></a></code></pre></div>
<hr>
</div>
</div>
<div id="filling-in-data" class="section level1">
<h1 class="hasAnchor">
<a href="#filling-in-data" class="anchor"></a>Filling in Data</h1>
<p>In a panel data context, missing data can be categorized into two kinds: explicit missing values for certain observations (<code>NA</code>s), or observations that are missing entirely - for example if person <code>1</code> has observations in period <code>1</code> and period <code>3</code>, but not period <code>2</code>.</p>
<p>You may wish to fill in either of these kinds of missing data using the data you do have.</p>
<div id="panel_fill" class="section level2">
<h2 class="hasAnchor">
<a href="#panel_fill" class="anchor"></a>panel_fill()</h2>
<p><code><a href="../reference/panel_fill.html">panel_fill()</a></code> will fill in gaps between time periods for individuals. For example, if person <code>1</code> has observations in period <code>1</code> and period <code>3</code>, but not period <code>2</code>, then <code><a href="../reference/panel_fill.html">panel_fill()</a></code> will add an observation to the data for person <code>1</code> in time period <code>2</code>. If there is more than one observation for person <code>1</code> in period <code>1</code>, then all of them will be copied for period <code>2</code>.</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb10-1" title="1"><span class="kw"><a href="../reference/panel_fill.html">panel_fill</a></span>(.df,</a>
<a class="sourceLine" id="cb10-2" title="2">  <span class="dt">.set_NA =</span> <span class="ot">FALSE</span>,</a>
<a class="sourceLine" id="cb10-3" title="3">  <span class="dt">.min =</span> <span class="ot">NA</span>,</a>
<a class="sourceLine" id="cb10-4" title="4">  <span class="dt">.max =</span> <span class="ot">NA</span>,</a>
<a class="sourceLine" id="cb10-5" title="5">  <span class="dt">.backwards =</span> <span class="ot">FALSE</span>,</a>
<a class="sourceLine" id="cb10-6" title="6">  <span class="dt">.group_i =</span> <span class="ot">TRUE</span>,</a>
<a class="sourceLine" id="cb10-7" title="7">  <span class="dt">.flag =</span> <span class="ot">NA</span>,</a>
<a class="sourceLine" id="cb10-8" title="8">  <span class="dt">.i =</span> <span class="ot">NULL</span>,</a>
<a class="sourceLine" id="cb10-9" title="9">  <span class="dt">.t =</span> <span class="ot">NULL</span>,</a>
<a class="sourceLine" id="cb10-10" title="10">  <span class="dt">.d =</span> <span class="dv">1</span>,</a>
<a class="sourceLine" id="cb10-11" title="11">  <span class="dt">.uniqcheck =</span> <span class="ot">FALSE</span>,</a>
<a class="sourceLine" id="cb10-12" title="12">  <span class="dt">.setpanel =</span> <span class="ot">TRUE</span></a>
<a class="sourceLine" id="cb10-13" title="13">)</a></code></pre></div>
<p><code><a href="../reference/panel_fill.html">panel_fill()</a></code> will give us some newly-created observations, and we need to decide what to fill them in with. By default, it will fill in values using what we see in the most recent non-missing observation. But we can set <code>.backwards = TRUE</code> to use the <em>next</em> non-missing observation instead, or use <code>.set_NA</code> to fill the new observations with missing data.</p>
<p><code>.set_NA</code> is a character vector of variable names that should be set to <code>NA</code> for newly-created observations, or set to <code>TRUE</code> to set everything except <code>.i</code> and <code>.t</code> to <code>NA</code>. You can also create a new variable indicating which observations are newly-created with <code>.flag</code>.</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb11-1" title="1"><span class="co"># Note the gap between periods 2 and 4 for person 1.</span></a>
<a class="sourceLine" id="cb11-2" title="2">df &lt;-<span class="st"> </span><span class="kw"><a href="../reference/pibble.html">pibble</a></span>(</a>
<a class="sourceLine" id="cb11-3" title="3">  <span class="dt">i =</span> <span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">2</span>, <span class="dv">2</span>),</a>
<a class="sourceLine" id="cb11-4" title="4">  <span class="dt">t =</span> <span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="dv">2</span>, <span class="dv">4</span>, <span class="dv">5</span>, <span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">3</span>),</a>
<a class="sourceLine" id="cb11-5" title="5">  <span class="dt">x =</span> <span class="dv">1</span><span class="op">:</span><span class="dv">6</span>,</a>
<a class="sourceLine" id="cb11-6" title="6">  <span class="dt">y =</span> <span class="dv">7</span><span class="op">:</span><span class="dv">12</span>,</a>
<a class="sourceLine" id="cb11-7" title="7">  <span class="dt">.i =</span> i,</a>
<a class="sourceLine" id="cb11-8" title="8">  <span class="dt">.t =</span> t</a>
<a class="sourceLine" id="cb11-9" title="9">)</a>
<a class="sourceLine" id="cb11-10" title="10"></a>
<a class="sourceLine" id="cb11-11" title="11"><span class="kw"><a href="../reference/panel_fill.html">panel_fill</a></span>(df, <span class="dt">.set_NA =</span> <span class="st">"y"</span>, <span class="dt">.flag =</span> <span class="st">"new_obs"</span>)</a>
<a class="sourceLine" id="cb11-12" title="12"><span class="co">#&gt; # A pibble: 7 x 5</span></a>
<a class="sourceLine" id="cb11-13" title="13"><span class="co">#&gt;       i     t     x     y new_obs</span></a>
<a class="sourceLine" id="cb11-14" title="14"><span class="co">#&gt;   &lt;dbl&gt; &lt;dbl&gt; &lt;int&gt; &lt;int&gt; &lt;lgl&gt;  </span></a>
<a class="sourceLine" id="cb11-15" title="15"><span class="co">#&gt; 1     1     2     1     7 FALSE  </span></a>
<a class="sourceLine" id="cb11-16" title="16"><span class="co">#&gt; 2     1     3     1    NA TRUE   </span></a>
<a class="sourceLine" id="cb11-17" title="17"><span class="co">#&gt; 3     1     4     2     8 FALSE  </span></a>
<a class="sourceLine" id="cb11-18" title="18"><span class="co">#&gt; 4     1     5     3     9 FALSE  </span></a>
<a class="sourceLine" id="cb11-19" title="19"><span class="co">#&gt; 5     2     1     4    10 FALSE  </span></a>
<a class="sourceLine" id="cb11-20" title="20"><span class="co">#&gt; 6     2     2     5    11 FALSE  </span></a>
<a class="sourceLine" id="cb11-21" title="21"><span class="co">#&gt; 7     2     3     6    12 FALSE</span></a>
<a class="sourceLine" id="cb11-22" title="22"><span class="kw"><a href="../reference/panel_fill.html">panel_fill</a></span>(df, <span class="dt">.set_NA =</span> <span class="st">"y"</span>, <span class="dt">.backwards =</span> <span class="ot">TRUE</span>)<span class="op">$</span>x</a>
<a class="sourceLine" id="cb11-23" title="23"><span class="co">#&gt; [1] 1 2 2 3 4 5 6</span></a></code></pre></div>
<p>By default, <code><a href="../reference/panel_fill.html">panel_fill()</a></code> will only fill in gaps between existing observations. However, commonly we might want to create new observations outside of the existing range, perhaps to create a fully balanced panel for ourselves. <code>.min</code> and <code>.max</code> will ensure that each individual has observations at least as far back as <code>.min</code>, and at least as far out as <code>.max</code>. Set <code>.min = min(t)</code> and <code>.max = max(t)</code> (where <code>t</code> is your time variable) to ensure a fully balanced panel.</p>
<p>Data for the outside-the-observed-range values will be taken from the closest observed value.</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb12-1" title="1"><span class="kw"><a href="../reference/panel_fill.html">panel_fill</a></span>(df, <span class="dt">.min =</span> <span class="kw"><a href="https://rdrr.io/r/base/Extremes.html">min</a></span>(df<span class="op">$</span>t), <span class="dt">.max =</span> <span class="kw"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span>(df<span class="op">$</span>t))</a>
<a class="sourceLine" id="cb12-2" title="2"><span class="co">#&gt; # A pibble: 10 x 4</span></a>
<a class="sourceLine" id="cb12-3" title="3"><span class="co">#&gt;        i     t     x     y</span></a>
<a class="sourceLine" id="cb12-4" title="4"><span class="co">#&gt;    &lt;dbl&gt; &lt;dbl&gt; &lt;int&gt; &lt;int&gt;</span></a>
<a class="sourceLine" id="cb12-5" title="5"><span class="co">#&gt;  1     1     1     1     7</span></a>
<a class="sourceLine" id="cb12-6" title="6"><span class="co">#&gt;  2     1     2     1     7</span></a>
<a class="sourceLine" id="cb12-7" title="7"><span class="co">#&gt;  3     1     3     1     7</span></a>
<a class="sourceLine" id="cb12-8" title="8"><span class="co">#&gt;  4     1     4     2     8</span></a>
<a class="sourceLine" id="cb12-9" title="9"><span class="co">#&gt;  5     1     5     3     9</span></a>
<a class="sourceLine" id="cb12-10" title="10"><span class="co">#&gt;  6     2     1     4    10</span></a>
<a class="sourceLine" id="cb12-11" title="11"><span class="co">#&gt;  7     2     2     5    11</span></a>
<a class="sourceLine" id="cb12-12" title="12"><span class="co">#&gt;  8     2     3     6    12</span></a>
<a class="sourceLine" id="cb12-13" title="13"><span class="co">#&gt;  9     2     4     6    12</span></a>
<a class="sourceLine" id="cb12-14" title="14"><span class="co">#&gt; 10     2     5     6    12</span></a></code></pre></div>
<p>The rest of the options include <code>.group_i</code> (by default, if <code>.i</code> can be found, data will be filled within-individual. Set <code>.group_i = FALSE</code> to ignore this), and standard arguments related to declaring the panel structure of the data (<code>.i</code>, <code>.t</code>, <code>.d</code>, <code>.uniqcheck</code>, see the “pibble” section above). <code>.setpanel</code> ensures that if you declare the panel structure in the <code><a href="../reference/panel_fill.html">panel_fill()</a></code> function, it will be maintained in the object you get back.</p>
</div>
<div id="panel_locf" class="section level2">
<h2 class="hasAnchor">
<a href="#panel_locf" class="anchor"></a>panel_locf()</h2>
<p><code><a href="../reference/panel_locf.html">panel_locf()</a></code> (“last observation carried forward”) will fill in explicit <code>NA</code> values using recently available data. It is very similar to <code><a href="https://rdrr.io/pkg/zoo/man/na.locf.html">zoo::na.locf()</a></code> except that it respects panel structure and is more flexible.</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb13-1" title="1"><span class="kw"><a href="../reference/panel_locf.html">panel_locf</a></span>(.var,</a>
<a class="sourceLine" id="cb13-2" title="2">  <span class="dt">.df =</span> <span class="kw"><a href="https://rdrr.io/r/base/get.html">get</a></span>(<span class="st">"."</span>, <span class="dt">envir =</span> <span class="kw"><a href="https://rdrr.io/r/base/sys.parent.html">parent.frame</a></span>()),</a>
<a class="sourceLine" id="cb13-3" title="3">  <span class="dt">.fill =</span> <span class="ot">NA</span>,</a>
<a class="sourceLine" id="cb13-4" title="4">  <span class="dt">.backwards =</span> <span class="ot">FALSE</span>,</a>
<a class="sourceLine" id="cb13-5" title="5">  <span class="dt">.resolve =</span> <span class="st">"error"</span>,</a>
<a class="sourceLine" id="cb13-6" title="6">  <span class="dt">.group_i =</span> <span class="ot">TRUE</span>,</a>
<a class="sourceLine" id="cb13-7" title="7">  <span class="dt">.i =</span> <span class="ot">NULL</span>,</a>
<a class="sourceLine" id="cb13-8" title="8">  <span class="dt">.t =</span> <span class="ot">NULL</span>,</a>
<a class="sourceLine" id="cb13-9" title="9">  <span class="dt">.d =</span> <span class="dv">1</span>,</a>
<a class="sourceLine" id="cb13-10" title="10">  <span class="dt">.uniqcheck =</span> <span class="ot">FALSE</span></a>
<a class="sourceLine" id="cb13-11" title="11">)</a></code></pre></div>
<p>where <code>.var</code> is the variable to be filled in, and <code>.df</code> is the data set that variable lives in. If the data set is being passed in via <code><a href="../reference/pipe.html">%&gt;%</a></code>, then <code>.df</code> will automatically pick it up and you don’t need to specify it.</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb14-1" title="1">df &lt;-<span class="st"> </span><span class="kw"><a href="../reference/pibble.html">pibble</a></span>(</a>
<a class="sourceLine" id="cb14-2" title="2">  <span class="dt">i =</span> <span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">2</span>, <span class="dv">2</span>),</a>
<a class="sourceLine" id="cb14-3" title="3">  <span class="dt">t =</span> <span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">3</span>, <span class="dv">2</span>, <span class="dv">3</span>, <span class="dv">4</span>),</a>
<a class="sourceLine" id="cb14-4" title="4">  <span class="dt">x =</span> <span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="dv">1</span>, <span class="ot">NA</span>, <span class="dv">3</span>, <span class="ot">NA</span>, <span class="dv">-3</span>, <span class="dv">4</span>),</a>
<a class="sourceLine" id="cb14-5" title="5">  <span class="dt">.i =</span> i,</a>
<a class="sourceLine" id="cb14-6" title="6">  <span class="dt">.t =</span> t</a>
<a class="sourceLine" id="cb14-7" title="7">)</a>
<a class="sourceLine" id="cb14-8" title="8"></a>
<a class="sourceLine" id="cb14-9" title="9"><span class="co"># Notice that the fourth observation doesn't get filled in</span></a>
<a class="sourceLine" id="cb14-10" title="10"><span class="co"># because it's the first observation for person 2, so nothing to fill in from</span></a>
<a class="sourceLine" id="cb14-11" title="11">df <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb14-12" title="12"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">x_filled =</span> <span class="kw"><a href="../reference/panel_locf.html">panel_locf</a></span>(x))</a>
<a class="sourceLine" id="cb14-13" title="13"><span class="co">#&gt; # A pibble:                         6 x 4</span></a>
<a class="sourceLine" id="cb14-14" title="14"><span class="co">#&gt; # Individual-level identifier (.i): i [2]</span></a>
<a class="sourceLine" id="cb14-15" title="15"><span class="co">#&gt; # Time variable (.t):               t [4]</span></a>
<a class="sourceLine" id="cb14-16" title="16"><span class="co">#&gt; # Gap (.d):                         1</span></a>
<a class="sourceLine" id="cb14-17" title="17"><span class="co">#&gt;       i     t     x x_filled</span></a>
<a class="sourceLine" id="cb14-18" title="18"><span class="co">#&gt;   &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;    &lt;dbl&gt;</span></a>
<a class="sourceLine" id="cb14-19" title="19"><span class="co">#&gt; 1     1     1     1        1</span></a>
<a class="sourceLine" id="cb14-20" title="20"><span class="co">#&gt; 2     1     2    NA        1</span></a>
<a class="sourceLine" id="cb14-21" title="21"><span class="co">#&gt; 3     1     3     3        3</span></a>
<a class="sourceLine" id="cb14-22" title="22"><span class="co">#&gt; 4     2     2    NA       NA</span></a>
<a class="sourceLine" id="cb14-23" title="23"><span class="co">#&gt; 5     2     3    -3       -3</span></a>
<a class="sourceLine" id="cb14-24" title="24"><span class="co">#&gt; 6     2     4     4        4</span></a></code></pre></div>
<p>You have a fair amount of control over how filling-in works. By default, data will be filled in using the most recent previous observation. But <code>.backwards = TRUE</code> will use the <em>next upcoming</em> observation instead. Also, by default, only <code>NA</code> values will be overwritten. But <code>.fill</code> will allow you to specify a vector of values (perhaps including <code>NA</code>) to be overwritten. This can be handy if you’re working with data that uses missingness indicators other than <code>NA</code>.</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb15-1" title="1">df <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">mutate</span>(</a>
<a class="sourceLine" id="cb15-2" title="2">  <span class="dt">x_filled =</span> <span class="kw"><a href="../reference/panel_locf.html">panel_locf</a></span>(x, <span class="dt">.backwards =</span> <span class="ot">TRUE</span>),</a>
<a class="sourceLine" id="cb15-3" title="3">  <span class="dt">x_no_neg3 =</span> <span class="kw"><a href="../reference/panel_locf.html">panel_locf</a></span>(x, <span class="dt">.backwards =</span> <span class="ot">TRUE</span>, <span class="dt">.fill =</span> <span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="ot">NA</span>, <span class="dv">-3</span>))</a>
<a class="sourceLine" id="cb15-4" title="4">)</a>
<a class="sourceLine" id="cb15-5" title="5"><span class="co">#&gt; # A pibble:                         6 x 5</span></a>
<a class="sourceLine" id="cb15-6" title="6"><span class="co">#&gt; # Individual-level identifier (.i): i [2]</span></a>
<a class="sourceLine" id="cb15-7" title="7"><span class="co">#&gt; # Time variable (.t):               t [4]</span></a>
<a class="sourceLine" id="cb15-8" title="8"><span class="co">#&gt; # Gap (.d):                         1</span></a>
<a class="sourceLine" id="cb15-9" title="9"><span class="co">#&gt;       i     t     x x_filled x_no_neg3</span></a>
<a class="sourceLine" id="cb15-10" title="10"><span class="co">#&gt;   &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;    &lt;dbl&gt;     &lt;dbl&gt;</span></a>
<a class="sourceLine" id="cb15-11" title="11"><span class="co">#&gt; 1     1     1     1        1         1</span></a>
<a class="sourceLine" id="cb15-12" title="12"><span class="co">#&gt; 2     1     2    NA        3         3</span></a>
<a class="sourceLine" id="cb15-13" title="13"><span class="co">#&gt; 3     1     3     3        3         3</span></a>
<a class="sourceLine" id="cb15-14" title="14"><span class="co">#&gt; 4     2     2    NA       -3         4</span></a>
<a class="sourceLine" id="cb15-15" title="15"><span class="co">#&gt; 5     2     3    -3       -3         4</span></a>
<a class="sourceLine" id="cb15-16" title="16"><span class="co">#&gt; 6     2     4     4        4         4</span></a></code></pre></div>
<p><code><a href="../reference/panel_locf.html">panel_locf()</a></code> will work even if <code>.i</code> and <code>.t</code> don’t uniquely identify the observations. However, this presents a problem! If there are <em>different values</em> of <code>.var</code> for a given combination of <code>.i</code> and <code>.t</code>, then which value do we choose to use for the purpose of filling in other observations? <code>.resolve</code> makes this choice. By default, there will be an “error” if values of <code>.var</code> are inconsistent within <code>.i</code> and <code>.t</code>. Or, set <code>.resolve</code> to a summary function like <code>.resolve = mean</code> or <code>.resolve = function(x) mean(x, na.rm = TRUE)</code> to resolve inconsistencies before filling in. If you have some <code>.i</code>/<code>.t</code> combinations with both missing and non-missing values, the missing values will be filled in using the same function.</p>
<div class="sourceCode" id="cb16"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb16-1" title="1">inconsistent_df &lt;-<span class="st"> </span><span class="kw"><a href="../reference/pibble.html">pibble</a></span>(</a>
<a class="sourceLine" id="cb16-2" title="2">  <span class="dt">i =</span> <span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">2</span>, <span class="dv">2</span>),</a>
<a class="sourceLine" id="cb16-3" title="3">  <span class="dt">t =</span> <span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">3</span>),</a>
<a class="sourceLine" id="cb16-4" title="4">  <span class="dt">x =</span> <span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="dv">1</span>, <span class="dv">2</span>, <span class="ot">NA</span>, <span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">3</span>),</a>
<a class="sourceLine" id="cb16-5" title="5">  <span class="dt">.i =</span> i,</a>
<a class="sourceLine" id="cb16-6" title="6">  <span class="dt">.t =</span> t</a>
<a class="sourceLine" id="cb16-7" title="7">)</a>
<a class="sourceLine" id="cb16-8" title="8"></a>
<a class="sourceLine" id="cb16-9" title="9">inconsistent_df <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">mutate</span>(</a>
<a class="sourceLine" id="cb16-10" title="10">  <span class="dt">x_filled =</span></a>
<a class="sourceLine" id="cb16-11" title="11">    <span class="kw"><a href="../reference/panel_locf.html">panel_locf</a></span>(x, <span class="dt">.resolve =</span> mean)</a>
<a class="sourceLine" id="cb16-12" title="12">)</a>
<a class="sourceLine" id="cb16-13" title="13"><span class="co">#&gt; # A pibble:                         6 x 4</span></a>
<a class="sourceLine" id="cb16-14" title="14"><span class="co">#&gt; # Individual-level identifier (.i): i [2]</span></a>
<a class="sourceLine" id="cb16-15" title="15"><span class="co">#&gt; # Time variable (.t):               t [3]</span></a>
<a class="sourceLine" id="cb16-16" title="16"><span class="co">#&gt; # Gap (.d):                         1</span></a>
<a class="sourceLine" id="cb16-17" title="17"><span class="co">#&gt;       i     t     x x_filled</span></a>
<a class="sourceLine" id="cb16-18" title="18"><span class="co">#&gt;   &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;    &lt;dbl&gt;</span></a>
<a class="sourceLine" id="cb16-19" title="19"><span class="co">#&gt; 1     1     1     1      1  </span></a>
<a class="sourceLine" id="cb16-20" title="20"><span class="co">#&gt; 2     1     1     2      2  </span></a>
<a class="sourceLine" id="cb16-21" title="21"><span class="co">#&gt; 3     1     2    NA      1.5</span></a>
<a class="sourceLine" id="cb16-22" title="22"><span class="co">#&gt; 4     2     1     1      1  </span></a>
<a class="sourceLine" id="cb16-23" title="23"><span class="co">#&gt; 5     2     2     2      2  </span></a>
<a class="sourceLine" id="cb16-24" title="24"><span class="co">#&gt; 6     2     3     3      3</span></a></code></pre></div>
<p>The rest of the options include <code>.group_i</code> (by default, if <code>.i</code> can be found, data will be filled within-individual. Set <code>.group_i = FALSE</code> to ignore this), and standard arguments related to declaring the panel structure of the data (<code>.i</code>, <code>.t</code>, <code>.d</code>, <code>.uniqcheck</code>, see the “pibble” section above). <code>.setpanel</code> ensures that if you declare the panel structure in the <code><a href="../reference/panel_fill.html">panel_fill()</a></code> function, it will be maintained in the object you get back.</p>
<hr>
</div>
</div>
<div id="panel-consistency" class="section level1">
<h1 class="hasAnchor">
<a href="#panel-consistency" class="anchor"></a>Panel Consistency</h1>
<p>In panel data, and especially hierarchical data, there are some variables that should be <em>fixed</em> within values of other variables. And if they’re not, you have a problem!</p>
<p>For example, consider the data set</p>
<div class="sourceCode" id="cb17"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb17-1" title="1">df &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span>(</a>
<a class="sourceLine" id="cb17-2" title="2">  <span class="dt">continent =</span> <span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"Asia"</span>, <span class="st">"Europe"</span>, <span class="st">"Europe"</span>, <span class="st">"S America"</span>, <span class="st">"S America"</span>),</a>
<a class="sourceLine" id="cb17-3" title="3">  <span class="dt">country =</span> <span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"France"</span>, <span class="st">"France"</span>, <span class="st">"France"</span>, <span class="st">"Brazil"</span>, <span class="st">"Brazil"</span>),</a>
<a class="sourceLine" id="cb17-4" title="4">  <span class="dt">year =</span> <span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="dv">2000</span>, <span class="dv">2001</span>, <span class="dv">2002</span>, <span class="dv">2000</span>, <span class="dv">2001</span>)</a>
<a class="sourceLine" id="cb17-5" title="5">)</a>
<a class="sourceLine" id="cb17-6" title="6"></a>
<a class="sourceLine" id="cb17-7" title="7">df</a>
<a class="sourceLine" id="cb17-8" title="8"><span class="co">#&gt;   continent country year</span></a>
<a class="sourceLine" id="cb17-9" title="9"><span class="co">#&gt; 1      Asia  France 2000</span></a>
<a class="sourceLine" id="cb17-10" title="10"><span class="co">#&gt; 2    Europe  France 2001</span></a>
<a class="sourceLine" id="cb17-11" title="11"><span class="co">#&gt; 3    Europe  France 2002</span></a>
<a class="sourceLine" id="cb17-12" title="12"><span class="co">#&gt; 4 S America  Brazil 2000</span></a>
<a class="sourceLine" id="cb17-13" title="13"><span class="co">#&gt; 5 S America  Brazil 2001</span></a></code></pre></div>
<p>The variable <code>continent</code> should never change within values of <code>country</code> - a country can’t change the continent it’s on! The fact that France changes continents from year to year in this data should be regarded as very fishy. It will be handy to spot these sorts of potential errors in your data set, and fix them if you think you know how.</p>
<div id="fixed_check" class="section level2">
<h2 class="hasAnchor">
<a href="#fixed_check" class="anchor"></a>fixed_check()</h2>
<p><code><a href="../reference/fixed_check.html">fixed_check()</a></code> will look in your data <code>.df</code> for inconsistencies in the value of some variables <code>.var</code> within values of other variables <code>.within</code>.</p>
<div class="sourceCode" id="cb18"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb18-1" title="1"><span class="kw"><a href="../reference/fixed_check.html">fixed_check</a></span>(.df,</a>
<a class="sourceLine" id="cb18-2" title="2">  <span class="dt">.var =</span> <span class="ot">NULL</span>,</a>
<a class="sourceLine" id="cb18-3" title="3">  <span class="dt">.within =</span> <span class="ot">NULL</span></a>
<a class="sourceLine" id="cb18-4" title="4">)</a></code></pre></div>
<p>You should pick variables for <code>.var</code> that are supposed to be constant within combinations of <code>.within</code>.</p>
<p>If your data has problems and is inconsistent, <code><a href="../reference/fixed_check.html">fixed_check()</a></code> will retun a list of data sets, one for each <code>.var</code> variable, containing the subset of the data that gives you problems. For our <code>df</code> with the France problem, that’s all of the France observations!</p>
<div class="sourceCode" id="cb19"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb19-1" title="1"><span class="kw"><a href="../reference/fixed_check.html">fixed_check</a></span>(df, <span class="dt">.var =</span> continent, <span class="dt">.within =</span> country)<span class="op">$</span>continent</a>
<a class="sourceLine" id="cb19-2" title="2"><span class="co">#&gt; # A tibble: 3 x 3</span></a>
<a class="sourceLine" id="cb19-3" title="3"><span class="co">#&gt;   continent country  year</span></a>
<a class="sourceLine" id="cb19-4" title="4"><span class="co">#&gt;   &lt;fct&gt;     &lt;fct&gt;   &lt;dbl&gt;</span></a>
<a class="sourceLine" id="cb19-5" title="5"><span class="co">#&gt; 1 Asia      France   2000</span></a>
<a class="sourceLine" id="cb19-6" title="6"><span class="co">#&gt; 2 Europe    France   2001</span></a>
<a class="sourceLine" id="cb19-7" title="7"><span class="co">#&gt; 3 Europe    France   2002</span></a></code></pre></div>
<p>If your data is fine, and all <code>.var</code> variables are indeed constant within combinations of <code>.within</code>, then <code><a href="../reference/fixed_check.html">fixed_check()</a></code> will return <code>TRUE</code>.</p>
<div class="sourceCode" id="cb20"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb20-1" title="1">consistent_df &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span>(</a>
<a class="sourceLine" id="cb20-2" title="2">  <span class="dt">state =</span> <span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">2</span>, <span class="dv">2</span>),</a>
<a class="sourceLine" id="cb20-3" title="3">  <span class="dt">year =</span> <span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="dv">2000</span>, <span class="dv">2001</span>, <span class="dv">2001</span>, <span class="dv">2000</span>, <span class="dv">2000</span>, <span class="dv">2001</span>),</a>
<a class="sourceLine" id="cb20-4" title="4">  <span class="dt">treatment =</span> <span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(F, T, T, T, T, F),</a>
<a class="sourceLine" id="cb20-5" title="5">  <span class="dt">outcome =</span> <span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">4.4</span>, <span class="fl">3.2</span>, <span class="fl">3.4</span>, <span class="fl">5.5</span>, <span class="fl">5.6</span>, <span class="dv">8</span>)</a>
<a class="sourceLine" id="cb20-6" title="6">)</a>
<a class="sourceLine" id="cb20-7" title="7"></a>
<a class="sourceLine" id="cb20-8" title="8"><span class="co"># Since this policy treatment is administered on the state level,</span></a>
<a class="sourceLine" id="cb20-9" title="9"><span class="co"># everyone in the same state/year should get the same treatment.</span></a>
<a class="sourceLine" id="cb20-10" title="10"><span class="co"># And they do!</span></a>
<a class="sourceLine" id="cb20-11" title="11"><span class="kw"><a href="../reference/fixed_check.html">fixed_check</a></span>(consistent_df, <span class="dt">.var =</span> treatment, <span class="dt">.within =</span> <span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(state, year))</a>
<a class="sourceLine" id="cb20-12" title="12"><span class="co">#&gt; [1] TRUE</span></a></code></pre></div>
<p>Some handy <code><a href="../reference/fixed_check.html">fixed_check()</a></code> tips:</p>
<ol style="list-style-type: decimal">
<li>
<code><a href="../reference/fixed_check.html">fixed_check()</a></code> returns either a <code>logical</code> or a <code>list</code> depending on the outcome. If you want to just get <code>FALSE</code> instead of a list of data sets, do <code><a href="https://rdrr.io/r/base/logical.html">is.logical(fixed_check())</a></code> instead of <code><a href="../reference/fixed_check.html">fixed_check()</a></code>.</li>
<li>If you do have problems and want a consistent data set, you can fix things by hand as you like, or you can use <code><a href="../reference/fixed_force.html">fixed_force()</a></code> (see below) to change the observations to be consistent, or to drop all inconsistent observations with <code><a href="../reference/fixed_force.html">fixed_force(.resolve = "drop")</a></code>.</li>
</ol>
</div>
<div id="fixed_force" class="section level2">
<h2 class="hasAnchor">
<a href="#fixed_force" class="anchor"></a>fixed_force()</h2>
<p><code><a href="../reference/fixed_force.html">fixed_force()</a></code> will take a data set <code>.df</code>, find any inconsistencies in the variables <code>.var</code> within combinations of the variables <code>.within</code>, and will “fix” those inconsistencies, using the function <code>.resolve</code> to select the correct values. It will flag any changed values with a new variable named <code>.flag</code>.</p>
<div class="sourceCode" id="cb21"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb21-1" title="1"><span class="kw"><a href="../reference/fixed_force.html">fixed_force</a></span>(..df,</a>
<a class="sourceLine" id="cb21-2" title="2">  <span class="dt">.var =</span> <span class="ot">NULL</span>,</a>
<a class="sourceLine" id="cb21-3" title="3">  <span class="dt">.within =</span> <span class="ot">NULL</span>,</a>
<a class="sourceLine" id="cb21-4" title="4">  <span class="dt">.resolve =</span> mode_order,</a>
<a class="sourceLine" id="cb21-5" title="5">  <span class="dt">.flag =</span> <span class="ot">NA</span></a>
<a class="sourceLine" id="cb21-6" title="6">)</a></code></pre></div>
<p>The default resolution function is <code><a href="../reference/mode_order.html">mode_order()</a></code> (see the Additional Calculations section), which calculates the mode, selecting the first-ordered value in the data if there are ties. The mode seems most relevant here, since the most likely (and responsible) use for <code><a href="../reference/fixed_force.html">fixed_force()</a></code> is when you have data that is mostly correct but just has a few odd values that are likely just miscodes. <code><a href="../reference/mode_order.html">mode_order()</a></code> also is not just limited to numeric variables.</p>
<p>Continuing with our France-in-Asia data set,</p>
<div class="sourceCode" id="cb22"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb22-1" title="1"><span class="kw"><a href="../reference/fixed_force.html">fixed_force</a></span>(df, <span class="dt">.var =</span> continent, <span class="dt">.within =</span> country, <span class="dt">.flag =</span> <span class="st">"altered"</span>)</a>
<a class="sourceLine" id="cb22-2" title="2"><span class="co">#&gt; # A tibble: 5 x 4</span></a>
<a class="sourceLine" id="cb22-3" title="3"><span class="co">#&gt;   continent country  year altered</span></a>
<a class="sourceLine" id="cb22-4" title="4"><span class="co">#&gt;   &lt;fct&gt;     &lt;fct&gt;   &lt;dbl&gt; &lt;lgl&gt;  </span></a>
<a class="sourceLine" id="cb22-5" title="5"><span class="co">#&gt; 1 Europe    France   2000 TRUE   </span></a>
<a class="sourceLine" id="cb22-6" title="6"><span class="co">#&gt; 2 Europe    France   2001 FALSE  </span></a>
<a class="sourceLine" id="cb22-7" title="7"><span class="co">#&gt; 3 Europe    France   2002 FALSE  </span></a>
<a class="sourceLine" id="cb22-8" title="8"><span class="co">#&gt; 4 S America Brazil   2000 FALSE  </span></a>
<a class="sourceLine" id="cb22-9" title="9"><span class="co">#&gt; 5 S America Brazil   2001 FALSE</span></a></code></pre></div>
<p>Another option for <code>.resolve</code> is to set <code>.resolve = "drop"</code> (or any other character, really), and it will drop the inconsistent observations.</p>
<div class="sourceCode" id="cb23"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb23-1" title="1"><span class="kw"><a href="../reference/fixed_force.html">fixed_force</a></span>(df, <span class="dt">.var =</span> continent, <span class="dt">.within =</span> country, <span class="dt">.resolve =</span> <span class="st">"drop"</span>)</a>
<a class="sourceLine" id="cb23-2" title="2"><span class="co">#&gt; # A tibble: 2 x 3</span></a>
<a class="sourceLine" id="cb23-3" title="3"><span class="co">#&gt;   continent country  year</span></a>
<a class="sourceLine" id="cb23-4" title="4"><span class="co">#&gt;   &lt;fct&gt;     &lt;fct&gt;   &lt;dbl&gt;</span></a>
<a class="sourceLine" id="cb23-5" title="5"><span class="co">#&gt; 1 S America Brazil   2000</span></a>
<a class="sourceLine" id="cb23-6" title="6"><span class="co">#&gt; 2 S America Brazil   2001</span></a></code></pre></div>
<hr>
</div>
</div>
<div id="joins" class="section level1">
<h1 class="hasAnchor">
<a href="#joins" class="anchor"></a>Joins</h1>
<p><code>pmdplyr</code> offers a set of wrappers for the <code><a href="https://dplyr.tidyverse.org/reference/join.html">dplyr::join()</a></code> functions.</p>
<div id="inexact_join" class="section level2">
<h2 class="hasAnchor">
<a href="#inexact_join" class="anchor"></a>inexact_join()</h2>
<p>The set of <code><a href="../reference/inexact_join.html">inexact_join()</a></code> functions maps directly onto the set of <code><a href="https://dplyr.tidyverse.org/reference/join.html">dplyr::join()</a></code> functions:</p>
<ul>
<li>
<strong>Mutating joins</strong>: <code><a href="../reference/inexact_join.html">inexact_inner_join()</a></code>, <code><a href="../reference/inexact_join.html">inexact_left_join()</a></code>, <code><a href="../reference/inexact_join.html">inexact_right_join()</a></code>, <code><a href="../reference/inexact_join.html">inexact_full_join()</a></code>
</li>
<li>
<strong>Filtering joins</strong>: <code><a href="../reference/inexact_join.html">inexact_semi_join()</a></code>, and <code><a href="../reference/inexact_join.html">inexact_anti_join()</a></code>
</li>
<li>
<strong>Nesting joins</strong>: <code><a href="../reference/inexact_join.html">inexact_nest_join()</a></code>
</li>
</ul>
<p>Here we will focus specifically on <code><a href="../reference/inexact_join.html">inexact_left_join()</a></code>. For the differences between the functions, see <code><a href="https://dplyr.tidyverse.org/reference/join.html">dplyr::join()</a></code>.</p>
<p><code>join()</code> functions take two data sets and join them based on matching values of a set of shared variables.</p>
<div class="sourceCode" id="cb24"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb24-1" title="1">left_df &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span>(</a>
<a class="sourceLine" id="cb24-2" title="2">  <span class="dt">i =</span> <span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">2</span>, <span class="dv">2</span>),</a>
<a class="sourceLine" id="cb24-3" title="3">  <span class="dt">t =</span> <span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">3</span>, <span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">3</span>),</a>
<a class="sourceLine" id="cb24-4" title="4">  <span class="dt">v1 =</span> <span class="dv">1</span><span class="op">:</span><span class="dv">6</span></a>
<a class="sourceLine" id="cb24-5" title="5">)</a>
<a class="sourceLine" id="cb24-6" title="6">right_df &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span>(</a>
<a class="sourceLine" id="cb24-7" title="7">  <span class="dt">i =</span> <span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">2</span>, <span class="dv">2</span>),</a>
<a class="sourceLine" id="cb24-8" title="8">  <span class="dt">t =</span> <span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="dv">0</span>, <span class="dv">2</span>, <span class="dv">4</span>, <span class="dv">0</span>, <span class="dv">2</span>, <span class="dv">4</span>),</a>
<a class="sourceLine" id="cb24-9" title="9">  <span class="dt">v2 =</span> <span class="dv">7</span><span class="op">:</span><span class="dv">12</span></a>
<a class="sourceLine" id="cb24-10" title="10">)</a>
<a class="sourceLine" id="cb24-11" title="11"></a>
<a class="sourceLine" id="cb24-12" title="12"><span class="co"># It automatically detects that i and t are the shared variables</span></a>
<a class="sourceLine" id="cb24-13" title="13"><span class="co"># and finds two combinations of those in left_df that are also</span></a>
<a class="sourceLine" id="cb24-14" title="14"><span class="co"># in right_df: i = 1, t = 2, and i = 2, t = 2. So it brings the</span></a>
<a class="sourceLine" id="cb24-15" title="15"><span class="co"># v2 values it can match up in to the joined data.</span></a>
<a class="sourceLine" id="cb24-16" title="16"><span class="co"># Other observations don't find a match</span></a>
<a class="sourceLine" id="cb24-17" title="17"><span class="kw">left_join</span>(left_df, right_df)</a>
<a class="sourceLine" id="cb24-18" title="18"><span class="co">#&gt;   i t v1 v2</span></a>
<a class="sourceLine" id="cb24-19" title="19"><span class="co">#&gt; 1 1 1  1 NA</span></a>
<a class="sourceLine" id="cb24-20" title="20"><span class="co">#&gt; 2 1 2  2  8</span></a>
<a class="sourceLine" id="cb24-21" title="21"><span class="co">#&gt; 3 1 3  3 NA</span></a>
<a class="sourceLine" id="cb24-22" title="22"><span class="co">#&gt; 4 2 1  4 NA</span></a>
<a class="sourceLine" id="cb24-23" title="23"><span class="co">#&gt; 5 2 2  5 11</span></a>
<a class="sourceLine" id="cb24-24" title="24"><span class="co">#&gt; 6 2 3  6 NA</span></a></code></pre></div>
<p>However, it is common (especially in a panel data context) to want to join two data frames where one of the variables does not line up exactly. For example, maybe we want those <code>t = 1</code> values in <code>left_df</code> to pick up the <code>t = 0</code> values in <code>right_df</code>.</p>
<p>We can do this, in a few different ways with an <code><a href="../reference/inexact_join.html">inexact_join()</a></code>:</p>
<div class="sourceCode" id="cb25"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb25-1" title="1"><span class="kw"><a href="../reference/inexact_join.html">inexact_left_join</a></span>(x, y,</a>
<a class="sourceLine" id="cb25-2" title="2">  <span class="dt">by =</span> <span class="ot">NULL</span>,</a>
<a class="sourceLine" id="cb25-3" title="3">  <span class="dt">copy =</span> <span class="ot">FALSE</span>,</a>
<a class="sourceLine" id="cb25-4" title="4">  <span class="dt">suffix =</span> <span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">".x"</span>, <span class="st">".y"</span>),</a>
<a class="sourceLine" id="cb25-5" title="5">  ...,</a>
<a class="sourceLine" id="cb25-6" title="6">  <span class="dt">var =</span> <span class="ot">NULL</span>,</a>
<a class="sourceLine" id="cb25-7" title="7">  <span class="dt">jvar =</span> <span class="ot">NULL</span>,</a>
<a class="sourceLine" id="cb25-8" title="8">  method,</a>
<a class="sourceLine" id="cb25-9" title="9">  <span class="dt">exact =</span> <span class="ot">TRUE</span></a>
<a class="sourceLine" id="cb25-10" title="10">)</a></code></pre></div>
<p>The first arguments: <code>x, y, by, copy, suffix, ...</code>, are standard arguments to be passed to <code>left_join()</code>. <code>x</code> and <code>y</code> are our left-hand and right-hand data sets, respectively. See <code><a href="https://dplyr.tidyverse.org/reference/join.html">dplyr::left_join()</a></code> for the rest.</p>
<p>We’ve added on here <code>var, jvar, method</code>, and <code>exact</code>.</p>
<p><code>var</code> is the variable in the left-hand data set that you would like to match inexactly on, and <code>jvar</code> is the variable(s) in the right-hand data set that you would like to match inexactly on. It’s important that the names of these variables aren’t shared, because the resulting data set will show how <code>var</code> and <code>jvar</code> line up. So let’s prepare our data by renaming <code>t</code> in <code>right_df</code> to something else so it’s not <code>t</code> in both data sets.</p>
<div class="sourceCode" id="cb26"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb26-1" title="1">right_df &lt;-<span class="st"> </span>right_df <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb26-2" title="2"><span class="st">  </span><span class="kw">rename</span>(<span class="dt">t_right =</span> t)</a></code></pre></div>
<p><code>method</code> determines <em>how</em> <code>var</code> and <code>jvar</code> will be matched up.</p>
<ul>
<li>
<code>method = "last"</code> matches <code>var</code> to the closest value of <code>jvar</code> that is <em>lower</em>, so those <code>t = 1</code> observations will get matched to <code>t_right = 0</code>, and <code>t = 3</code> will get matched to <code>t_right = 2</code> (meaning that <code>t_right = 2</code> will get matched to both <code>t = 2</code> and <code>t = 3</code>):</li>
</ul>
<div class="sourceCode" id="cb27"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb27-1" title="1"><span class="kw"><a href="../reference/inexact_join.html">inexact_left_join</a></span>(left_df,</a>
<a class="sourceLine" id="cb27-2" title="2">  right_df,</a>
<a class="sourceLine" id="cb27-3" title="3">  <span class="dt">var =</span> t, <span class="dt">jvar =</span> t_right,</a>
<a class="sourceLine" id="cb27-4" title="4">  <span class="dt">method =</span> <span class="st">"last"</span></a>
<a class="sourceLine" id="cb27-5" title="5">)</a>
<a class="sourceLine" id="cb27-6" title="6"><span class="co">#&gt;   i t v1 t_right v2</span></a>
<a class="sourceLine" id="cb27-7" title="7"><span class="co">#&gt; 1 1 1  1       0  7</span></a>
<a class="sourceLine" id="cb27-8" title="8"><span class="co">#&gt; 2 1 2  2       2  8</span></a>
<a class="sourceLine" id="cb27-9" title="9"><span class="co">#&gt; 3 1 3  3       2  8</span></a>
<a class="sourceLine" id="cb27-10" title="10"><span class="co">#&gt; 4 2 1  4       0 10</span></a>
<a class="sourceLine" id="cb27-11" title="11"><span class="co">#&gt; 5 2 2  5       2 11</span></a>
<a class="sourceLine" id="cb27-12" title="12"><span class="co">#&gt; 6 2 3  6       2 11</span></a></code></pre></div>
<ul>
<li>
<code>method = "next"</code> matches <code>var</code> to the closest value of <code>jvar</code> that is <em>higher</em>, so now <code>t = 1</code> will get matched to <code>t_right = 2</code>, and <code>t = 3</code> will get matched to <code>t_right = 4</code>:</li>
</ul>
<div class="sourceCode" id="cb28"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb28-1" title="1"><span class="kw"><a href="../reference/inexact_join.html">inexact_left_join</a></span>(left_df,</a>
<a class="sourceLine" id="cb28-2" title="2">  right_df,</a>
<a class="sourceLine" id="cb28-3" title="3">  <span class="dt">var =</span> t, <span class="dt">jvar =</span> t_right,</a>
<a class="sourceLine" id="cb28-4" title="4">  <span class="dt">method =</span> <span class="st">"next"</span></a>
<a class="sourceLine" id="cb28-5" title="5">)</a>
<a class="sourceLine" id="cb28-6" title="6"><span class="co">#&gt;   i t v1 t_right v2</span></a>
<a class="sourceLine" id="cb28-7" title="7"><span class="co">#&gt; 1 1 1  1       2  8</span></a>
<a class="sourceLine" id="cb28-8" title="8"><span class="co">#&gt; 2 1 2  2       2  8</span></a>
<a class="sourceLine" id="cb28-9" title="9"><span class="co">#&gt; 3 1 3  3       4  9</span></a>
<a class="sourceLine" id="cb28-10" title="10"><span class="co">#&gt; 4 2 1  4       2 11</span></a>
<a class="sourceLine" id="cb28-11" title="11"><span class="co">#&gt; 5 2 2  5       2 11</span></a>
<a class="sourceLine" id="cb28-12" title="12"><span class="co">#&gt; 6 2 3  6       4 12</span></a></code></pre></div>
<ul>
<li>
<code>method = "closest"</code> will match <code>var</code> to the closest value of <code>jvar</code> in either direction. If there’s a tie, it will pick the lower value of <code>jvar</code>. So now <code>t = 1</code> will pick <code>t_right = 0</code> (out of a tie between <code>0</code> and <code>2</code>), and <code>t = 3</code> will match to <code>t = 2</code>:</li>
</ul>
<div class="sourceCode" id="cb29"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb29-1" title="1"><span class="kw"><a href="../reference/inexact_join.html">inexact_left_join</a></span>(left_df,</a>
<a class="sourceLine" id="cb29-2" title="2">  right_df,</a>
<a class="sourceLine" id="cb29-3" title="3">  <span class="dt">var =</span> t, <span class="dt">jvar =</span> t_right,</a>
<a class="sourceLine" id="cb29-4" title="4">  <span class="dt">method =</span> <span class="st">"closest"</span></a>
<a class="sourceLine" id="cb29-5" title="5">)</a>
<a class="sourceLine" id="cb29-6" title="6"><span class="co">#&gt;   i t v1 t_right v2</span></a>
<a class="sourceLine" id="cb29-7" title="7"><span class="co">#&gt; 1 1 1  1       0  7</span></a>
<a class="sourceLine" id="cb29-8" title="8"><span class="co">#&gt; 2 1 2  2       2  8</span></a>
<a class="sourceLine" id="cb29-9" title="9"><span class="co">#&gt; 3 1 3  3       2  8</span></a>
<a class="sourceLine" id="cb29-10" title="10"><span class="co">#&gt; 4 2 1  4       0 10</span></a>
<a class="sourceLine" id="cb29-11" title="11"><span class="co">#&gt; 5 2 2  5       2 11</span></a>
<a class="sourceLine" id="cb29-12" title="12"><span class="co">#&gt; 6 2 3  6       2 11</span></a></code></pre></div>
<ul>
<li>Finally, <code>method = "between"</code> is for matching <code>var</code> to a set of two <code>jvar</code>s that define the beginning and end of a <em>range</em>. Make sure that the ranges are non-overlapping within the joining variables, or else you will get strange results (specifically, it should join to the earliest-starting range). So now, given the way we define <code>t_bottom</code> and <code>t_top</code> below, <code>t = 1</code> should go in the range <code>t_bottom = 0, t_top = 2</code>, and <code>t = 2</code> and <code>t = 3</code> should both go in the range <code>t_bottom = 2, t_top = 4</code>.</li>
</ul>
<div class="sourceCode" id="cb30"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb30-1" title="1">right_df &lt;-<span class="st"> </span>right_df <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb30-2" title="2"><span class="st">  </span><span class="kw">rename</span>(<span class="dt">t_bottom =</span> t_right) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb30-3" title="3"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">t_top =</span> t_bottom <span class="op">+</span><span class="st"> </span><span class="dv">2</span>)</a>
<a class="sourceLine" id="cb30-4" title="4"></a>
<a class="sourceLine" id="cb30-5" title="5"><span class="kw"><a href="../reference/inexact_join.html">inexact_left_join</a></span>(left_df,</a>
<a class="sourceLine" id="cb30-6" title="6">  right_df,</a>
<a class="sourceLine" id="cb30-7" title="7">  <span class="dt">var =</span> t, <span class="dt">jvar =</span> <span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(t_bottom, t_top),</a>
<a class="sourceLine" id="cb30-8" title="8">  <span class="dt">method =</span> <span class="st">"between"</span></a>
<a class="sourceLine" id="cb30-9" title="9">)</a>
<a class="sourceLine" id="cb30-10" title="10"><span class="co">#&gt;   i t v1 t_bottom v2 t_top</span></a>
<a class="sourceLine" id="cb30-11" title="11"><span class="co">#&gt; 1 1 1  1        0  7     2</span></a>
<a class="sourceLine" id="cb30-12" title="12"><span class="co">#&gt; 2 1 2  2        2  8     4</span></a>
<a class="sourceLine" id="cb30-13" title="13"><span class="co">#&gt; 3 1 3  3        2  8     4</span></a>
<a class="sourceLine" id="cb30-14" title="14"><span class="co">#&gt; 4 2 1  4        0 10     2</span></a>
<a class="sourceLine" id="cb30-15" title="15"><span class="co">#&gt; 5 2 2  5        2 11     4</span></a>
<a class="sourceLine" id="cb30-16" title="16"><span class="co">#&gt; 6 2 3  6        2 11     4</span></a></code></pre></div>
<p>So that leaves us with <code>exact</code>. <code>exact</code> determines whether or not an exact match is an acceptable match, and interprets <code>"last"</code> as “this value or earlier” and <code>"next"</code> as “this value or later”. Generally, for joining purposes, you’ll want this to be <code>TRUE</code>. But perhaps you don’t! Maybe you want “earlier” or “later” only to get something like “the most recent previous value” for <code>method = "last"</code>. In that case, set this to <code>FALSE</code>.</p>
<p>In the case of <code>method = "between"</code>, it’s especially important to keep track of <code>exact</code> because it’s common for one range to start at the exact endpoint of another. If the end of one range is the exact start of another, <code>exact = c(TRUE, FALSE)</code> or <code>exact = c(FALSE, TRUE)</code> is recommended to avoid overlaps. Defaults to <code>exact = c(TRUE, FALSE)</code>.</p>
</div>
<div id="safe_join" class="section level2">
<h2 class="hasAnchor">
<a href="#safe_join" class="anchor"></a>safe_join()</h2>
<p>When joining two data sets <code>x</code> and <code>y</code> on a set of shared variables <code>by</code>, there are four ways in which they can be matched: one-to-many (<code>by</code> uniquely identifies rows in <code>x</code> but not <code>y</code>, so each observation in <code>x</code> will be matched to several in <code>y</code>), many-to-one (<code>by</code> uniquely identifies rows in <code>y</code> but not <code>x</code>, so each observation in <code>y</code> will be matched to several in <code>x</code>), one-to-one (<code>by</code> uniquely identifies rows in both <code>x</code> and <code>y</code>, so each observation in <code>x</code> will be matched to exactly one in <code>y</code>), and many-to-many (<code>by</code> does not uniquely identify rows in either <code>x</code> or <code>y</code>).</p>
<p>Unfortunately, when you perform a <code>join()</code> or <code><a href="../reference/inexact_join.html">inexact_join()</a></code>, it doesn’t tell you which of those you’ve just done! This can be especially problematic if you’ve accidentally done a many-to-many join, since many-to-many join often leads to unexpected results.</p>
<p><code><a href="../reference/safe_join.html">safe_join()</a></code> is a wrapper for all <code>join()</code> and <code><a href="../reference/inexact_join.html">inexact_join()</a></code> functions which tells you whether you are, in fact, doing the join you expect to be doing, and returns an error if you’re not.</p>
<div class="sourceCode" id="cb31"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb31-1" title="1"><span class="kw"><a href="../reference/safe_join.html">safe_join</a></span>(x, y,</a>
<a class="sourceLine" id="cb31-2" title="2">  <span class="dt">expect =</span> <span class="ot">NULL</span>,</a>
<a class="sourceLine" id="cb31-3" title="3">  <span class="dt">join =</span> <span class="ot">NULL</span>,</a>
<a class="sourceLine" id="cb31-4" title="4">  ...</a>
<a class="sourceLine" id="cb31-5" title="5">)</a></code></pre></div>
<p><code>x</code>, <code>y</code>, and <code>...</code> are the standard <code>join()</code>/<code><a href="../reference/inexact_join.html">inexact_join()</a></code> arguments that you would normally use. See <code><a href="https://rdrr.io/r/utils/help.html">help(join, package = "dplyr")</a></code> or the <code>inexact_join</code> section above to see what arguments might go in <code>...</code> to pass through to those functions, such as <code>suffix</code> or <code>var</code>.</p>
<p><code>expect</code> is a character variable where you specify the type of join you <em>think</em> you’re about to do. You can specify this either as one-to-many / many-to-one / one-to-one directly, or you can specify which of the two data sets (<code>x</code> or <code>y</code>) you think should be uniquely identified by the joining variables.</p>
<ul>
<li>
<code>expect = "1:1" or</code>expect = c(“x”, “y”)<code>or</code>expect = “xy”` indicates that you anticipate to join one-to-one.</li>
<li>
<code>expect = "m:1" or</code>expect = “y”` indicates that you expect to join many-to-one.</li>
<li>
<code>expect = "1:m" or "expect = "x"</code> indicates that you expect to join one-to-many.</li>
<li>
<code>expect = "no m:m"</code> indicates that you don’t care whether you’re one-to-one, one-to-many, or many-to-one, as long as you’re not many-to-many.</li>
<li>There is no <code>expect</code> option that allows you to run a many-to-many join.</li>
</ul>
<p><code><a href="../reference/safe_join.html">safe_join()</a></code> will return an error if your data do not match your <code>expect</code> selection.</p>
<p>If your data <em>does</em> match your <code>expect</code> option, then it will look to your <code>join</code>. <code>join</code> is the function for the <code>join</code> or <code>inexact_join</code> you’d like to run, for example <code>join = inexact_left_join</code>.</p>
<p>If run without a <code>join</code> specified, <code><a href="../reference/safe_join.html">safe_join()</a></code> will return <code>TRUE</code> if you’re good to go. If run with a <code>join</code> specified, then instead <code><a href="../reference/safe_join.html">safe_join()</a></code> will pass your data on to the function and actually run the join for you.</p>
<p>There is little reason to run any <code>join()</code> or <code><a href="../reference/inexact_join.html">inexact_join()</a></code> without going through <code><a href="../reference/safe_join.html">safe_join()</a></code>. It will help you avoid some nasty surprises!</p>
<div class="sourceCode" id="cb32"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb32-1" title="1"><span class="co"># left is panel data and i does not uniquely identify observations</span></a>
<a class="sourceLine" id="cb32-2" title="2">left &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span>(</a>
<a class="sourceLine" id="cb32-3" title="3">  <span class="dt">i =</span> <span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">2</span>),</a>
<a class="sourceLine" id="cb32-4" title="4">  <span class="dt">t =</span> <span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">1</span>, <span class="dv">2</span>),</a>
<a class="sourceLine" id="cb32-5" title="5">  <span class="dt">a =</span> <span class="dv">1</span><span class="op">:</span><span class="dv">4</span></a>
<a class="sourceLine" id="cb32-6" title="6">)</a>
<a class="sourceLine" id="cb32-7" title="7"><span class="co"># right is individual-level data uniquely identified by i</span></a>
<a class="sourceLine" id="cb32-8" title="8">right &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span>(</a>
<a class="sourceLine" id="cb32-9" title="9">  <span class="dt">i =</span> <span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="dv">1</span>, <span class="dv">2</span>),</a>
<a class="sourceLine" id="cb32-10" title="10">  <span class="dt">b =</span> <span class="dv">1</span><span class="op">:</span><span class="dv">2</span></a>
<a class="sourceLine" id="cb32-11" title="11">)</a>
<a class="sourceLine" id="cb32-12" title="12"></a>
<a class="sourceLine" id="cb32-13" title="13"><span class="co"># I think that I can do a one-to-one merge on i</span></a>
<a class="sourceLine" id="cb32-14" title="14"><span class="co"># Forgetting that left is identified by i and t together</span></a>
<a class="sourceLine" id="cb32-15" title="15"><span class="co"># So, this produces an error</span></a>
<a class="sourceLine" id="cb32-16" title="16"><span class="kw"><a href="https://rdrr.io/r/base/try.html">try</a></span>(</a>
<a class="sourceLine" id="cb32-17" title="17">  <span class="kw"><a href="../reference/safe_join.html">safe_join</a></span>(left, right, <span class="dt">expect =</span> <span class="st">"1:1"</span>, <span class="dt">join =</span> left_join)</a>
<a class="sourceLine" id="cb32-18" title="18">)</a>
<a class="sourceLine" id="cb32-19" title="19"><span class="co">#&gt; Error in safe_join(left, right, expect = "1:1", join = left_join) : </span></a>
<a class="sourceLine" id="cb32-20" title="20"><span class="co">#&gt;   The left-hand data set x is not uniquely identified by the joining variable i.</span></a>
<a class="sourceLine" id="cb32-21" title="21"></a>
<a class="sourceLine" id="cb32-22" title="22"><span class="co"># If I realize I'm doing a many-to-one merge, that is correct,</span></a>
<a class="sourceLine" id="cb32-23" title="23"><span class="co"># so safe_join will return TRUE if we don't specify a join</span></a>
<a class="sourceLine" id="cb32-24" title="24"><span class="co"># or perform the join for us if we do</span></a>
<a class="sourceLine" id="cb32-25" title="25"><span class="kw"><a href="../reference/safe_join.html">safe_join</a></span>(left, right, <span class="dt">expect =</span> <span class="st">"m:1"</span>)</a>
<a class="sourceLine" id="cb32-26" title="26"><span class="co">#&gt; [1] TRUE</span></a>
<a class="sourceLine" id="cb32-27" title="27"><span class="kw"><a href="../reference/safe_join.html">safe_join</a></span>(left, right, <span class="dt">expect =</span> <span class="st">"m:1"</span>, <span class="dt">join =</span> left_join)</a>
<a class="sourceLine" id="cb32-28" title="28"><span class="co">#&gt;   i t a b</span></a>
<a class="sourceLine" id="cb32-29" title="29"><span class="co">#&gt; 1 1 1 1 1</span></a>
<a class="sourceLine" id="cb32-30" title="30"><span class="co">#&gt; 2 1 2 2 1</span></a>
<a class="sourceLine" id="cb32-31" title="31"><span class="co">#&gt; 3 2 1 3 2</span></a>
<a class="sourceLine" id="cb32-32" title="32"><span class="co">#&gt; 4 2 2 4 2</span></a></code></pre></div>
<hr>
</div>
</div>
<div id="mutate-variations" class="section level1">
<h1 class="hasAnchor">
<a href="#mutate-variations" class="anchor"></a>Mutate Variations</h1>
<p><code>pmdplyr</code> adds several new versions of <code><a href="https://dplyr.tidyverse.org/reference/mutate.html">dplyr::mutate()</a></code> that help with some common panel-data manipulation needs.</p>
<div id="mutate_subset" class="section level2">
<h2 class="hasAnchor">
<a href="#mutate_subset" class="anchor"></a>mutate_subset()</h2>
<p><code><a href="../reference/mutate_subset.html">mutate_subset()</a></code> is a function that performs a <code><a href="https://dplyr.tidyverse.org/reference/summarise.html">dplyr::summarize()</a></code> command on a subset (<code>.filter</code>) of your data, and then takes the result and applies it to all observations in your data (or all observations within group, if grouped).</p>
<p>The most common use of this is to <em>partially widen</em> your data. Panel data can be stored in “wide” format, where there is one row per individual and, for each variable, one column per time period, or the more common (and assumed in <code>pmdplyr</code>) “long” format where there is one (or possibly more than one) row per individual/time period.</p>
<p>The benefit of wide data is that it makes it very easy to compare variables across wide stretches of time. How much has asset <code>1</code> increased in value from the beginning of the sample? Easy in wide data, a little trickier in long (although it could be done with a <code><a href="../reference/tlag.html">tlag()</a></code>, see tlag() section).</p>
<p>If you only have a few such comparisons to make, <code><a href="../reference/mutate_subset.html">mutate_subset()</a></code> lets you make them without fully widening the data. Just make a “value at the beginning of the sample” variable, if that’s all you need, without having to bother fully widening.</p>
<p>Another common use is to make specific comparisons within groups. If I want to know how your earnings compare to the average earnings in your state, I can just do a <code><a href="../reference/panel_calculations.html">within_i()</a></code> calculation (see Additional Calculations section). But what if I want to know how your earnings compare to the average earnings <em>of college graduates</em> in your state? That’s harder. But <code><a href="../reference/mutate_subset.html">mutate_subset()</a></code> makes it easy.</p>
<div class="sourceCode" id="cb33"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb33-1" title="1"><span class="kw"><a href="../reference/mutate_subset.html">mutate_subset</a></span>(.df,</a>
<a class="sourceLine" id="cb33-2" title="2">  ...,</a>
<a class="sourceLine" id="cb33-3" title="3">  .filter,</a>
<a class="sourceLine" id="cb33-4" title="4">  <span class="dt">.group_i =</span> <span class="ot">TRUE</span>,</a>
<a class="sourceLine" id="cb33-5" title="5">  <span class="dt">.i =</span> <span class="ot">NULL</span>,</a>
<a class="sourceLine" id="cb33-6" title="6">  <span class="dt">.t =</span> <span class="ot">NULL</span>,</a>
<a class="sourceLine" id="cb33-7" title="7">  <span class="dt">.d =</span> <span class="ot">NA</span>,</a>
<a class="sourceLine" id="cb33-8" title="8">  <span class="dt">.uniqcheck =</span> <span class="ot">FALSE</span>,</a>
<a class="sourceLine" id="cb33-9" title="9">  <span class="dt">.setpanel =</span> <span class="ot">TRUE</span></a>
<a class="sourceLine" id="cb33-10" title="10">)</a></code></pre></div>
<p>where <code>.df</code> is the data set being mutated and <code>...</code> is a set of name-value pairs of expressions in the style of <code><a href="https://dplyr.tidyverse.org/reference/mutate.html">dplyr::mutate</a></code>. Note that, since the idea here is to get a summary measure from a filtered group, expressions should be written such that they would be valid arguments in <code><a href="https://dplyr.tidyverse.org/reference/summarise.html">dplyr::summarize()</a></code>.</p>
<p><code>.filter</code> is a logical condition that describes the observations that you want to perform the <code>...</code> calculations on.</p>
<p>Let’s perform the analysis we described above, comparing an individual’s earnings to the average earnings of college graduates in their state:</p>
<div class="sourceCode" id="cb34"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb34-1" title="1">df &lt;-<span class="st"> </span><span class="kw"><a href="../reference/pibble.html">pibble</a></span>(</a>
<a class="sourceLine" id="cb34-2" title="2">  <span class="dt">state =</span> <span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"CA"</span>, <span class="st">"CA"</span>, <span class="st">"CA"</span>, <span class="st">"NV"</span>, <span class="st">"NV"</span>, <span class="st">"NV"</span>),</a>
<a class="sourceLine" id="cb34-3" title="3">  <span class="dt">college =</span> <span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="ot">TRUE</span>, <span class="ot">TRUE</span>, <span class="ot">FALSE</span>, <span class="ot">TRUE</span>, <span class="ot">FALSE</span>, <span class="ot">FALSE</span>),</a>
<a class="sourceLine" id="cb34-4" title="4">  <span class="dt">earn =</span> <span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">3</span>, <span class="dv">2</span>, <span class="dv">3</span>, <span class="dv">2</span>),</a>
<a class="sourceLine" id="cb34-5" title="5">  <span class="dt">.i =</span> state</a>
<a class="sourceLine" id="cb34-6" title="6">)</a>
<a class="sourceLine" id="cb34-7" title="7"></a>
<a class="sourceLine" id="cb34-8" title="8">df <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb34-9" title="9"><span class="st">  </span><span class="co"># Calculate average earnings of college grads</span></a>
<a class="sourceLine" id="cb34-10" title="10"><span class="st">  </span><span class="kw"><a href="../reference/mutate_subset.html">mutate_subset</a></span>(<span class="dt">college_earnings =</span> <span class="kw"><a href="https://rdrr.io/r/base/mean.html">mean</a></span>(earn), <span class="dt">.filter =</span> college <span class="op">==</span><span class="st"> </span><span class="ot">TRUE</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb34-11" title="11"><span class="st">  </span><span class="co"># And compare to our own earnings</span></a>
<a class="sourceLine" id="cb34-12" title="12"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">earnings_vs_college =</span> earn <span class="op">-</span><span class="st"> </span>college_earnings)</a>
<a class="sourceLine" id="cb34-13" title="13"><span class="co">#&gt; # A pibble:                         6 x 5</span></a>
<a class="sourceLine" id="cb34-14" title="14"><span class="co">#&gt; # Individual-level identifier (.i): state [2]</span></a>
<a class="sourceLine" id="cb34-15" title="15"><span class="co">#&gt; # Gap (.d):                         1</span></a>
<a class="sourceLine" id="cb34-16" title="16"><span class="co">#&gt;   state college  earn college_earnings earnings_vs_college</span></a>
<a class="sourceLine" id="cb34-17" title="17"><span class="co">#&gt;   &lt;chr&gt; &lt;lgl&gt;   &lt;dbl&gt;            &lt;dbl&gt;               &lt;dbl&gt;</span></a>
<a class="sourceLine" id="cb34-18" title="18"><span class="co">#&gt; 1 CA    TRUE        1              1.5                -0.5</span></a>
<a class="sourceLine" id="cb34-19" title="19"><span class="co">#&gt; 2 CA    TRUE        2              1.5                 0.5</span></a>
<a class="sourceLine" id="cb34-20" title="20"><span class="co">#&gt; 3 CA    FALSE       3              1.5                 1.5</span></a>
<a class="sourceLine" id="cb34-21" title="21"><span class="co">#&gt; 4 NV    TRUE        2              2                   0  </span></a>
<a class="sourceLine" id="cb34-22" title="22"><span class="co">#&gt; 5 NV    FALSE       3              2                   1  </span></a>
<a class="sourceLine" id="cb34-23" title="23"><span class="co">#&gt; 6 NV    FALSE       2              2                   0</span></a></code></pre></div>
<p>The rest of the options include <code>.group_i</code> (by default, if <code>.i</code> can be found, analysis will be performed within-individual. Set <code>.group_i = FALSE</code> to ignore this), and standard arguments related to declaring the panel structure of the data (<code>.i</code>, <code>.t</code>, <code>.d</code>, <code>.uniqcheck</code>, see the “pibble” section above). The <code>.d = NA</code> will become <code>.d = 1</code> if either <code>.i</code> or <code>.t</code> are declared. <code>.setpanel</code> ensures that if you declare the panel structure in the <code><a href="../reference/panel_fill.html">panel_fill()</a></code> function, it will be maintained in the object you get back.</p>
</div>
<div id="mutate_cascade" class="section level2">
<h2 class="hasAnchor">
<a href="#mutate_cascade" class="anchor"></a>mutate_cascade()</h2>
<p><code><a href="../reference/mutate_cascade.html">mutate_cascade()</a></code> performs <code><a href="https://dplyr.tidyverse.org/reference/mutate.html">dplyr::mutate()</a></code> on a data set one time period at a time, in order, allowing the mutate from each time period to finish before moving on to the next one. The changes “cascade down” through time. This can be handy if your <code>mutate()</code> command makes reference to earlier time periods using (usually) <code><a href="../reference/tlag.html">tlag()</a></code> (see below) and you want changes in one period to be passed down to the next.</p>
<p>In effect, you can think of <code><a href="../reference/mutate_cascade.html">mutate_cascade()</a></code> as behaving much like <code><a href="https://rdrr.io/r/base/cumsum.html">cumsum()</a></code>, <code><a href="https://rdrr.io/r/base/cumsum.html">cumprod()</a></code>, <code><a href="https://rdrr.io/r/base/cumsum.html">cummax()</a></code> or <code><a href="https://rdrr.io/r/base/cumsum.html">cummin()</a></code>, except that it (1) respects the panel structure of the data, (2) works when you have multiple observations per <code>.i</code>/<code>.t</code>, (3) is much more flexible, and (4) is much slower.</p>
<p>As of this writing <code><a href="../reference/mutate_cascade.html">mutate_cascade()</a></code> is pretty darn slow (after all, if you have T time periods, you’re running T separate <code>mutate</code> commands in a loop!), so be careful in using it.</p>
<div class="sourceCode" id="cb35"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb35-1" title="1"><span class="kw"><a href="../reference/mutate_cascade.html">mutate_cascade</a></span>(.df,</a>
<a class="sourceLine" id="cb35-2" title="2">  ...,</a>
<a class="sourceLine" id="cb35-3" title="3">  <span class="dt">.skip =</span> <span class="ot">TRUE</span>,</a>
<a class="sourceLine" id="cb35-4" title="4">  <span class="dt">.backwards =</span> <span class="ot">FALSE</span>,</a>
<a class="sourceLine" id="cb35-5" title="5">  <span class="dt">.group_i =</span> <span class="ot">TRUE</span>,</a>
<a class="sourceLine" id="cb35-6" title="6">  <span class="dt">.i =</span> <span class="ot">NULL</span>,</a>
<a class="sourceLine" id="cb35-7" title="7">  <span class="dt">.t =</span> <span class="ot">NULL</span>,</a>
<a class="sourceLine" id="cb35-8" title="8">  <span class="dt">.d =</span> <span class="ot">NA</span>,</a>
<a class="sourceLine" id="cb35-9" title="9">  <span class="dt">.uniqcheck =</span> <span class="ot">FALSE</span>,</a>
<a class="sourceLine" id="cb35-10" title="10">  <span class="dt">.setpanel =</span> <span class="ot">TRUE</span></a>
<a class="sourceLine" id="cb35-11" title="11">)</a></code></pre></div>
<p>where <code>.df</code> is the data set being mutated, and <code>...</code> is the list of expressions to be passed to <code><a href="https://dplyr.tidyverse.org/reference/mutate.html">dplyr::mutate()</a></code>.</p>
<p><code>.skip</code> instructs <code><a href="../reference/mutate_cascade.html">mutate_cascade()</a></code> to skip over the first time period (or last time period if <code>backwards = TRUE</code>). This should usually be set to <code>TRUE</code>, since most usages of <code><a href="../reference/mutate_cascade.html">mutate_cascade()</a></code> involve a <code><a href="../reference/tlag.html">tlag()</a></code>, and the <code><a href="../reference/tlag.html">tlag()</a></code> of something in the first time period is usually <code>NA</code>. Then, you’ve filled in that first-period <code>NA</code> - now the <code><a href="../reference/tlag.html">tlag()</a></code> in period 2 is NA as well, and it will cascade down to make your whole data set <code>NA</code>.</p>
<p><code>.backwards</code>, unsurprisingly, tells <code><a href="../reference/mutate_cascade.html">mutate_cascade()</a></code> to start with the last time period and work backwards.</p>
<p>Let’s do a very simple example and use <code><a href="../reference/mutate_cascade.html">mutate_cascade()</a></code> to build a present discounted value. We have an asset with a <code>payout</code> each period, and we have a discount factor <code>.95</code>. We can build a present discounted value <code>PDV</code> by taking the <code>PDV</code> in the next period, multiplying it by <code>.95</code>, and adding on the current <code>payout</code>. But we need to calculate <code>PDV</code> one period at a time, so that we can use each period’s calculation to calculate the previous one.</p>
<div class="sourceCode" id="cb36"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb36-1" title="1">df &lt;-<span class="st"> </span><span class="kw"><a href="../reference/pibble.html">pibble</a></span>(</a>
<a class="sourceLine" id="cb36-2" title="2">  <span class="dt">t =</span> <span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">3</span>, <span class="dv">4</span>, <span class="dv">5</span>),</a>
<a class="sourceLine" id="cb36-3" title="3">  <span class="dt">payout =</span> <span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="dv">3</span>, <span class="dv">4</span>, <span class="dv">2</span>, <span class="dv">2</span>, <span class="dv">4</span>),</a>
<a class="sourceLine" id="cb36-4" title="4">  <span class="dt">.t =</span> t</a>
<a class="sourceLine" id="cb36-5" title="5">) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb36-6" title="6"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">PDV =</span> payout) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb36-7" title="7"><span class="st">  </span><span class="kw"><a href="../reference/mutate_cascade.html">mutate_cascade</a></span>(<span class="dt">PDV =</span> payout <span class="op">+</span><span class="st"> </span><span class="fl">.95</span> <span class="op">*</span><span class="st"> </span><span class="kw"><a href="../reference/tlag.html">tlag</a></span>(PDV, <span class="dt">.n =</span> <span class="dv">-1</span>), <span class="dt">.backwards =</span> <span class="ot">TRUE</span>)</a></code></pre></div>
<p>As expected, the <code>PDV</code> in period <code>5</code> is just the payout: <code>4</code>. In period <code>4</code> it’s <code>2 + .95*4 = 5.8</code>. Then in period <code>3</code> it’s <code>2 + .95*5.8 = 7.51</code>, and so on.</p>
<p>The rest of the options include <code>.group_i</code> (by default, if <code>.i</code> can be found, analysis will be performed within-individual. Set <code>.group_i = FALSE</code> to ignore this), and standard arguments related to declaring the panel structure of the data (<code>.i</code>, <code>.t</code>, <code>.d</code>, <code>.uniqcheck</code>, see the “pibble” section above). The <code>.d = NA</code> will become <code>.d = 1</code> if either <code>.i</code> or <code>.t</code> are declared. <code>.setpanel</code> ensures that if you declare the panel structure in the <code><a href="../reference/panel_fill.html">panel_fill()</a></code> function, it will be maintained in the object you get back.</p>
<hr>
</div>
</div>
<div id="tlag" class="section level1">
<h1 class="hasAnchor">
<a href="#tlag" class="anchor"></a>tlag()</h1>
<p><code><a href="../reference/tlag.html">tlag()</a></code> is a function that lags a variable in time. It respects the panel structure of the data, works with multiple observations per combination of <code>.i</code>/<code>.t</code>, and, unlike <code><a href="https://rdrr.io/pkg/plm/man/re-export_functions.html">plm::lag()</a></code>, doesn’t run into masking problems by sharing a name with <code><a href="https://dplyr.tidyverse.org/reference/lead-lag.html">dplyr::lag()</a></code>. Do remember that <code><a href="https://dplyr.tidyverse.org/reference/lead-lag.html">dplyr::lag()</a></code> does not lag data in time, it lags data in the order of the data set.</p>
<div class="sourceCode" id="cb37"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb37-1" title="1"><span class="kw"><a href="../reference/tlag.html">tlag</a></span>(.var,</a>
<a class="sourceLine" id="cb37-2" title="2">  <span class="dt">.df =</span> <span class="kw"><a href="https://rdrr.io/r/base/get.html">get</a></span>(<span class="st">"."</span>, <span class="dt">envir =</span> <span class="kw"><a href="https://rdrr.io/r/base/sys.parent.html">parent.frame</a></span>()),</a>
<a class="sourceLine" id="cb37-3" title="3">  <span class="dt">.n =</span> <span class="dv">1</span>,</a>
<a class="sourceLine" id="cb37-4" title="4">  <span class="dt">.default =</span> <span class="ot">NA</span>,</a>
<a class="sourceLine" id="cb37-5" title="5">  <span class="dt">.quick =</span> <span class="ot">FALSE</span>,</a>
<a class="sourceLine" id="cb37-6" title="6">  <span class="dt">.resolve =</span> <span class="st">"error"</span>,</a>
<a class="sourceLine" id="cb37-7" title="7">  <span class="dt">.group_i =</span> <span class="ot">TRUE</span>,</a>
<a class="sourceLine" id="cb37-8" title="8">  <span class="dt">.i =</span> <span class="ot">NULL</span>,</a>
<a class="sourceLine" id="cb37-9" title="9">  <span class="dt">.t =</span> <span class="ot">NULL</span>,</a>
<a class="sourceLine" id="cb37-10" title="10">  <span class="dt">.d =</span> <span class="ot">NA</span>,</a>
<a class="sourceLine" id="cb37-11" title="11">  <span class="dt">.uniqcheck =</span> <span class="ot">FALSE</span></a>
<a class="sourceLine" id="cb37-12" title="12">)</a></code></pre></div>
<p>where <code>.var</code> is the variable being lagged, , and <code>.df</code> is the data set that variable lives in. If the data set is being passed in via <code><a href="../reference/pipe.html">%&gt;%</a></code>, then <code>.df</code> will automatically pick it up and you don’t need to specify it.</p>
<p><code>.n</code> is the number of periods to lag. Negative values of <code>.n</code> imply a lead instead of a lag (as in the example in <code><a href="../reference/mutate_cascade.html">mutate_cascade()</a></code> in the Mutate Variations section). There’s not a separate <code>tlead()</code> function.</p>
<p><code>.default</code> is the value to use if a lag does not exist. By default, this is <code>NA</code>. So if you have data in periods <code>1</code> and <code>3</code> but not <code>2</code>, then the <code>tlag</code> in the third period will produce <code>NA</code>.</p>
<p><code>.quick</code> is a setting you can use if your data is very nicely structured, with rows uniquely identified by <code>.i</code>/<code>.t</code> and there are either no gaps between time periods or <code>.d = 0</code>. <code><a href="../reference/tlag.html">tlag()</a></code> will run more quickly with <code>.quick = TRUE</code>, but will produce incorrect results if these conditions are not met.</p>
<div class="sourceCode" id="cb38"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb38-1" title="1">df &lt;-<span class="st"> </span><span class="kw"><a href="../reference/pibble.html">pibble</a></span>(</a>
<a class="sourceLine" id="cb38-2" title="2">  <span class="dt">i =</span> <span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">2</span>, <span class="dv">2</span>),</a>
<a class="sourceLine" id="cb38-3" title="3">  <span class="dt">t =</span> <span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">3</span>, <span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">3</span>),</a>
<a class="sourceLine" id="cb38-4" title="4">  <span class="dt">x =</span> <span class="dv">1</span><span class="op">:</span><span class="dv">6</span>,</a>
<a class="sourceLine" id="cb38-5" title="5">  <span class="dt">.i =</span> i,</a>
<a class="sourceLine" id="cb38-6" title="6">  <span class="dt">.t =</span> t</a>
<a class="sourceLine" id="cb38-7" title="7">) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb38-8" title="8"><span class="st">  </span><span class="co"># A lag and a lead, filling in the lead with 0 instead of NA</span></a>
<a class="sourceLine" id="cb38-9" title="9"><span class="st">  </span><span class="kw">mutate</span>(</a>
<a class="sourceLine" id="cb38-10" title="10">    <span class="dt">x_lag =</span> <span class="kw"><a href="../reference/tlag.html">tlag</a></span>(x),</a>
<a class="sourceLine" id="cb38-11" title="11">    <span class="dt">x_lead =</span> <span class="kw"><a href="../reference/tlag.html">tlag</a></span>(x, <span class="dt">.n =</span> <span class="dv">-1</span>, <span class="dt">.default =</span> <span class="dv">0</span>),</a>
<a class="sourceLine" id="cb38-12" title="12">    <span class="co"># Our data satisfies the .quick conditions so we can</span></a>
<a class="sourceLine" id="cb38-13" title="13">    <span class="co"># do that for a little extra speed</span></a>
<a class="sourceLine" id="cb38-14" title="14">    <span class="dt">x_quicklag =</span> <span class="kw"><a href="../reference/tlag.html">tlag</a></span>(x, <span class="dt">.quick =</span> <span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="cb38-15" title="15">  )</a>
<a class="sourceLine" id="cb38-16" title="16"></a>
<a class="sourceLine" id="cb38-17" title="17">df</a>
<a class="sourceLine" id="cb38-18" title="18"><span class="co">#&gt; # A pibble:                         6 x 6</span></a>
<a class="sourceLine" id="cb38-19" title="19"><span class="co">#&gt; # Individual-level identifier (.i): i [2]</span></a>
<a class="sourceLine" id="cb38-20" title="20"><span class="co">#&gt; # Time variable (.t):               t [3]</span></a>
<a class="sourceLine" id="cb38-21" title="21"><span class="co">#&gt; # Gap (.d):                         1</span></a>
<a class="sourceLine" id="cb38-22" title="22"><span class="co">#&gt;       i     t     x x_lag x_lead x_quicklag</span></a>
<a class="sourceLine" id="cb38-23" title="23"><span class="co">#&gt;   &lt;dbl&gt; &lt;dbl&gt; &lt;int&gt; &lt;int&gt;  &lt;dbl&gt;      &lt;int&gt;</span></a>
<a class="sourceLine" id="cb38-24" title="24"><span class="co">#&gt; 1     1     1     1    NA      2         NA</span></a>
<a class="sourceLine" id="cb38-25" title="25"><span class="co">#&gt; 2     1     2     2     1      3          1</span></a>
<a class="sourceLine" id="cb38-26" title="26"><span class="co">#&gt; 3     1     3     3     2      0          2</span></a>
<a class="sourceLine" id="cb38-27" title="27"><span class="co">#&gt; 4     2     1     4    NA      5         NA</span></a>
<a class="sourceLine" id="cb38-28" title="28"><span class="co">#&gt; 5     2     2     5     4      6          4</span></a>
<a class="sourceLine" id="cb38-29" title="29"><span class="co">#&gt; 6     2     3     6     5      0          5</span></a></code></pre></div>
<p>If <code>.var</code> is not constant within combinations of <code>.i</code> and <code>.t</code> we have a problem! Which value do we choose to use for the purpose of filling in other observations? <code>.resolve</code> makes this choice. By default, there will be an “error” if values of <code>.var</code> are inconsistent within <code>.i</code> and <code>.t</code>. Or, set <code>.resolve</code> to a summary function like <code>.resolve = mean</code> or <code>.resolve = function(x) mean(x, na.rm = TRUE)</code> to resolve inconsistencies before filling in.</p>
<div class="sourceCode" id="cb39"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb39-1" title="1">df &lt;-<span class="st"> </span><span class="kw"><a href="../reference/pibble.html">pibble</a></span>(</a>
<a class="sourceLine" id="cb39-2" title="2">  <span class="dt">i =</span> <span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">2</span>, <span class="dv">2</span>),</a>
<a class="sourceLine" id="cb39-3" title="3">  <span class="dt">t =</span> <span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">2</span>),</a>
<a class="sourceLine" id="cb39-4" title="4">  <span class="dt">x =</span> <span class="dv">1</span><span class="op">:</span><span class="dv">6</span>,</a>
<a class="sourceLine" id="cb39-5" title="5">  <span class="dt">.i =</span> i,</a>
<a class="sourceLine" id="cb39-6" title="6">  <span class="dt">.t =</span> t</a>
<a class="sourceLine" id="cb39-7" title="7">) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb39-8" title="8"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">x_lag =</span> <span class="kw"><a href="../reference/tlag.html">tlag</a></span>(x, <span class="dt">.resolve =</span> mean))</a>
<a class="sourceLine" id="cb39-9" title="9"></a>
<a class="sourceLine" id="cb39-10" title="10">df</a>
<a class="sourceLine" id="cb39-11" title="11"><span class="co">#&gt; # A pibble:                         6 x 4</span></a>
<a class="sourceLine" id="cb39-12" title="12"><span class="co">#&gt; # Individual-level identifier (.i): i [2]</span></a>
<a class="sourceLine" id="cb39-13" title="13"><span class="co">#&gt; # Time variable (.t):               t [2]</span></a>
<a class="sourceLine" id="cb39-14" title="14"><span class="co">#&gt; # Gap (.d):                         1</span></a>
<a class="sourceLine" id="cb39-15" title="15"><span class="co">#&gt;       i     t     x x_lag</span></a>
<a class="sourceLine" id="cb39-16" title="16"><span class="co">#&gt;   &lt;dbl&gt; &lt;dbl&gt; &lt;int&gt; &lt;dbl&gt;</span></a>
<a class="sourceLine" id="cb39-17" title="17"><span class="co">#&gt; 1     1     1     1  NA  </span></a>
<a class="sourceLine" id="cb39-18" title="18"><span class="co">#&gt; 2     1     1     2  NA  </span></a>
<a class="sourceLine" id="cb39-19" title="19"><span class="co">#&gt; 3     1     2     3   1.5</span></a>
<a class="sourceLine" id="cb39-20" title="20"><span class="co">#&gt; 4     2     1     4  NA  </span></a>
<a class="sourceLine" id="cb39-21" title="21"><span class="co">#&gt; 5     2     1     5  NA  </span></a>
<a class="sourceLine" id="cb39-22" title="22"><span class="co">#&gt; 6     2     2     6   4.5</span></a></code></pre></div>
<p>The rest of the options include <code>.group_i</code> (by default, if <code>.i</code> can be found, lags will be performed within-individual. Set <code>.group_i = FALSE</code> to ignore this), and standard arguments related to declaring the panel structure of the data (<code>.i</code>, <code>.t</code>, <code>.d</code>, <code>.uniqcheck</code>, see the “pibble” section above). The <code>.d = NA</code> will become <code>.d = 1</code> if either <code>.i</code> or <code>.t</code> are declared. <code>.setpanel</code> ensures that if you declare the panel structure in the <code><a href="../reference/panel_fill.html">panel_fill()</a></code> function, it will be maintained in the object you get back.</p>
<hr>
</div>
<div id="additional-calculations" class="section level1">
<h1 class="hasAnchor">
<a href="#additional-calculations" class="anchor"></a>Additional Calculations</h1>
<p><code>pmdplyr</code> contains several additional functions that produce calculations of interest.</p>
<div id="between_i" class="section level2">
<h2 class="hasAnchor">
<a href="#between_i" class="anchor"></a>between_i()</h2>
<p><code><a href="../reference/panel_calculations.html">between_i()</a></code> performs the <em>between transformation</em>. In particular, it isolates the variation between <code>.i</code> groups in a variable <code>.var</code>, throwing out all variation within <code>.i</code> groups. The result is identical within combinations of <code>.i</code>.</p>
<p>The specific calculation that is performed is</p>
<p><span class="math display">\[between.i(x) = \bar{x}_i - \bar{x}\]</span></p>
<p>where <span class="math inline">\(\bar{x}_i\)</span> is the mean of <code>x</code> within the <code>.i</code> groups, and <span class="math inline">\(\bar{x}\)</span> is the grand mean of <code>x</code> over all observations.</p>
<p>Be aware that this is different from <code><a href="https://rdrr.io/pkg/plm/man/pseries.html">plm::between()</a></code>, which returns <span class="math inline">\(\bar{x}_i\)</span> and does not subtract out <span class="math inline">\(\bar{x}\)</span>.</p>
<p>The syntax for <code><a href="../reference/panel_calculations.html">between_i()</a></code> is:</p>
<div class="sourceCode" id="cb40"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb40-1" title="1"><span class="kw"><a href="../reference/panel_calculations.html">between_i</a></span>(.var,</a>
<a class="sourceLine" id="cb40-2" title="2">  <span class="dt">.df =</span> <span class="kw"><a href="https://rdrr.io/r/base/get.html">get</a></span>(<span class="st">"."</span>, <span class="dt">envir =</span> <span class="kw"><a href="https://rdrr.io/r/base/sys.parent.html">parent.frame</a></span>()),</a>
<a class="sourceLine" id="cb40-3" title="3">  <span class="dt">.fcn =</span> <span class="cf">function</span>(x) <span class="kw"><a href="https://rdrr.io/r/base/mean.html">mean</a></span>(x, <span class="dt">na.rm =</span> <span class="ot">TRUE</span>),</a>
<a class="sourceLine" id="cb40-4" title="4">  <span class="dt">.i =</span> <span class="ot">NULL</span>,</a>
<a class="sourceLine" id="cb40-5" title="5">  <span class="dt">.t =</span> <span class="ot">NULL</span>,</a>
<a class="sourceLine" id="cb40-6" title="6">  <span class="dt">uniqcheck =</span> <span class="ot">FALSE</span></a>
<a class="sourceLine" id="cb40-7" title="7">)</a></code></pre></div>
<p>Where <code>.var</code> is the variable on which the transformation is performed, and <code>.df</code> is the data set. If the data set is being passed in via <code><a href="../reference/pipe.html">%&gt;%</a></code>, then <code>.df</code> will automatically pick it up and you don’t need to specify it. <code>.fcn</code> is the function applied to calculate the group and grand values, i.e. <span class="math inline">\(.fcn(x) = \bar{x}\)</span>. The standard definition of the between transformation is for this to be the mean, but it has been left flexible.</p>
<p>The rest of the options include standard arguments related to declaring the panel structure of the data (<code>.i</code>, <code>.t</code>, <code>.uniqcheck</code>, see the “pibble” section above). <code>.d</code> is omitted because it is irrelevant to the calculation.</p>
<p>An example of the between transformation follows:</p>
<div class="sourceCode" id="cb41"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb41-1" title="1">df &lt;-<span class="st"> </span><span class="kw"><a href="../reference/pibble.html">pibble</a></span>(</a>
<a class="sourceLine" id="cb41-2" title="2">  <span class="dt">i =</span> <span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">2</span>),</a>
<a class="sourceLine" id="cb41-3" title="3">  <span class="dt">x =</span> <span class="dv">1</span><span class="op">:</span><span class="dv">4</span>,</a>
<a class="sourceLine" id="cb41-4" title="4">  <span class="dt">.i =</span> i</a>
<a class="sourceLine" id="cb41-5" title="5">) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb41-6" title="6"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">between_x =</span> <span class="kw"><a href="../reference/panel_calculations.html">between_i</a></span>(x))</a>
<a class="sourceLine" id="cb41-7" title="7"></a>
<a class="sourceLine" id="cb41-8" title="8"><span class="co"># Notice that the grand mean is...</span></a>
<a class="sourceLine" id="cb41-9" title="9"><span class="kw"><a href="https://rdrr.io/r/base/mean.html">mean</a></span>(df<span class="op">$</span>x)</a>
<a class="sourceLine" id="cb41-10" title="10"><span class="co">#&gt; [1] 2.5</span></a>
<a class="sourceLine" id="cb41-11" title="11"><span class="co"># And the mean within groups is...</span></a>
<a class="sourceLine" id="cb41-12" title="12">df <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb41-13" title="13"><span class="st">  </span><span class="kw">group_by</span>(i) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb41-14" title="14"><span class="st">  </span><span class="kw">summarize</span>(<span class="dt">x =</span> <span class="kw"><a href="https://rdrr.io/r/base/mean.html">mean</a></span>(x))</a>
<a class="sourceLine" id="cb41-15" title="15"><span class="co">#&gt; # A pibble:                         2 x 2</span></a>
<a class="sourceLine" id="cb41-16" title="16"><span class="co">#&gt; # Individual-level identifier (.i): i [2]</span></a>
<a class="sourceLine" id="cb41-17" title="17"><span class="co">#&gt; # Gap (.d):                         1</span></a>
<a class="sourceLine" id="cb41-18" title="18"><span class="co">#&gt;       i     x</span></a>
<a class="sourceLine" id="cb41-19" title="19"><span class="co">#&gt;   &lt;dbl&gt; &lt;dbl&gt;</span></a>
<a class="sourceLine" id="cb41-20" title="20"><span class="co">#&gt; 1     1   1.5</span></a>
<a class="sourceLine" id="cb41-21" title="21"><span class="co">#&gt; 2     2   3.5</span></a>
<a class="sourceLine" id="cb41-22" title="22"></a>
<a class="sourceLine" id="cb41-23" title="23"><span class="co"># So the between calculation should be</span></a>
<a class="sourceLine" id="cb41-24" title="24"><span class="co"># 1.5 - 2.5 = -1 and 3.5 - 2.5 = 1 for the different groups:</span></a>
<a class="sourceLine" id="cb41-25" title="25">df<span class="op">$</span>between_x</a>
<a class="sourceLine" id="cb41-26" title="26"><span class="co">#&gt; [1] -1 -1  1  1</span></a></code></pre></div>
</div>
<div id="within_i" class="section level2">
<h2 class="hasAnchor">
<a href="#within_i" class="anchor"></a>within_i()</h2>
<p><code><a href="../reference/panel_calculations.html">within_i()</a></code> performs the <em>within transformation</em>. In particular, it isolates the variation within <code>.i</code> groups in a variable <code>.var</code>, throwing out all variation between <code>.i</code> groups. The result averages out to <code>0</code> within combinations of <code>.i</code>.</p>
<p>The specific calculation that is performed is</p>
<p><span class="math display">\[within.i(x) = x_i - \bar{x}_i\]</span></p>
<p>where <span class="math inline">\(\bar{x}_i\)</span> is the mean of <code>x</code> within the <code>.i</code> groups.</p>
<p>The syntax for <code>within_i</code> is:</p>
<div class="sourceCode" id="cb42"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb42-1" title="1"><span class="kw"><a href="../reference/panel_calculations.html">within_i</a></span>(.var,</a>
<a class="sourceLine" id="cb42-2" title="2">  <span class="dt">.df =</span> <span class="kw"><a href="https://rdrr.io/r/base/get.html">get</a></span>(<span class="st">"."</span>, <span class="dt">envir =</span> <span class="kw"><a href="https://rdrr.io/r/base/sys.parent.html">parent.frame</a></span>()),</a>
<a class="sourceLine" id="cb42-3" title="3">  <span class="dt">.fcn =</span> <span class="cf">function</span>(x) <span class="kw"><a href="https://rdrr.io/r/base/mean.html">mean</a></span>(x, <span class="dt">na.rm =</span> <span class="ot">TRUE</span>),</a>
<a class="sourceLine" id="cb42-4" title="4">  <span class="dt">.i =</span> <span class="ot">NULL</span>,</a>
<a class="sourceLine" id="cb42-5" title="5">  <span class="dt">.t =</span> <span class="ot">NULL</span>,</a>
<a class="sourceLine" id="cb42-6" title="6">  <span class="dt">uniqcheck =</span> <span class="ot">FALSE</span></a>
<a class="sourceLine" id="cb42-7" title="7">)</a></code></pre></div>
<p>Where <code>.var</code> is the variable on which the transformation is performed, and <code>.df</code> is the data set. If the data set is being passed in via <code><a href="../reference/pipe.html">%&gt;%</a></code>, then <code>.df</code> will automatically pick it up and you don’t need to specify it. <code>.fcn</code> is the function applied to calculate the group values, i.e. <span class="math inline">\(.fcn(x) = \bar{x}\)</span>. The standard definition of the within transformation is for this to be the mean, but it has been left flexible.</p>
<p>The rest of the options include standard arguments related to declaring the panel structure of the data (<code>.i</code>, <code>.t</code>, <code>.uniqcheck</code>, see the “pibble” section above). <code>.d</code> is omitted because it is irrelevant to the calculation.</p>
<p>An example of the between transformation follows:</p>
<div class="sourceCode" id="cb43"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb43-1" title="1">df &lt;-<span class="st"> </span><span class="kw"><a href="../reference/pibble.html">pibble</a></span>(</a>
<a class="sourceLine" id="cb43-2" title="2">  <span class="dt">i =</span> <span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">2</span>),</a>
<a class="sourceLine" id="cb43-3" title="3">  <span class="dt">x =</span> <span class="dv">1</span><span class="op">:</span><span class="dv">4</span>,</a>
<a class="sourceLine" id="cb43-4" title="4">  <span class="dt">.i =</span> i</a>
<a class="sourceLine" id="cb43-5" title="5">) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb43-6" title="6"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">within_x =</span> <span class="kw"><a href="../reference/panel_calculations.html">within_i</a></span>(x))</a>
<a class="sourceLine" id="cb43-7" title="7"></a>
<a class="sourceLine" id="cb43-8" title="8"><span class="co"># Notice that the mean within groups is...</span></a>
<a class="sourceLine" id="cb43-9" title="9">df <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb43-10" title="10"><span class="st">  </span><span class="kw">group_by</span>(i) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb43-11" title="11"><span class="st">  </span><span class="kw">summarize</span>(<span class="dt">x =</span> <span class="kw"><a href="https://rdrr.io/r/base/mean.html">mean</a></span>(x))</a>
<a class="sourceLine" id="cb43-12" title="12"><span class="co">#&gt; # A pibble:                         2 x 2</span></a>
<a class="sourceLine" id="cb43-13" title="13"><span class="co">#&gt; # Individual-level identifier (.i): i [2]</span></a>
<a class="sourceLine" id="cb43-14" title="14"><span class="co">#&gt; # Gap (.d):                         1</span></a>
<a class="sourceLine" id="cb43-15" title="15"><span class="co">#&gt;       i     x</span></a>
<a class="sourceLine" id="cb43-16" title="16"><span class="co">#&gt;   &lt;dbl&gt; &lt;dbl&gt;</span></a>
<a class="sourceLine" id="cb43-17" title="17"><span class="co">#&gt; 1     1   1.5</span></a>
<a class="sourceLine" id="cb43-18" title="18"><span class="co">#&gt; 2     2   3.5</span></a>
<a class="sourceLine" id="cb43-19" title="19"></a>
<a class="sourceLine" id="cb43-20" title="20"><span class="co"># So the between calculation should be</span></a>
<a class="sourceLine" id="cb43-21" title="21"><span class="co"># 1 - 1.5 = -.5 and 2 - 1.5 = .5 for individual 1</span></a>
<a class="sourceLine" id="cb43-22" title="22"><span class="co"># and 3 - 3.5 = -.5 and 4 - 3.5 = .5 individual 2:</span></a>
<a class="sourceLine" id="cb43-23" title="23">df<span class="op">$</span>within_x</a>
<a class="sourceLine" id="cb43-24" title="24"><span class="co">#&gt; [1] -0.5  0.5 -0.5  0.5</span></a></code></pre></div>
</div>
<div id="mode_order" class="section level2">
<h2 class="hasAnchor">
<a href="#mode_order" class="anchor"></a>mode_order()</h2>
<p>R does not have a base function for calculating the mode of a vector. But <code><a href="../reference/fixed_force.html">fixed_force()</a></code> wanted one, and so here we are. This function has been exported for general use in case it comes in handy elsewhere.</p>
<p>In particular, <code><a href="../reference/mode_order.html">mode_order()</a></code> calculates the mode of a vector and, if there are ties between two different values, selects the one that comes earlier in the original vector order.</p>
<div class="sourceCode" id="cb44"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb44-1" title="1"><span class="co"># 2 appears twice while everything else appears once; 2 is the mode.</span></a>
<a class="sourceLine" id="cb44-2" title="2">x &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">2</span>, <span class="ot">NA</span>, <span class="dv">5</span>, <span class="dv">3</span>, <span class="dv">4</span>)</a>
<a class="sourceLine" id="cb44-3" title="3"><span class="kw"><a href="../reference/mode_order.html">mode_order</a></span>(x)</a>
<a class="sourceLine" id="cb44-4" title="4"><span class="co">#&gt; [1] 2</span></a>
<a class="sourceLine" id="cb44-5" title="5"></a>
<a class="sourceLine" id="cb44-6" title="6"><span class="co"># 1 or 2 could be the mode.</span></a>
<a class="sourceLine" id="cb44-7" title="7"><span class="co"># Ties are broken by order in the vector.</span></a>
<a class="sourceLine" id="cb44-8" title="8">x &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="dv">2</span>, <span class="dv">2</span>, <span class="dv">1</span>, <span class="dv">1</span>)</a>
<a class="sourceLine" id="cb44-9" title="9"><span class="kw"><a href="../reference/mode_order.html">mode_order</a></span>(x)</a>
<a class="sourceLine" id="cb44-10" title="10"><span class="co">#&gt; [1] 2</span></a></code></pre></div>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="sidebar">
        <div id="tocnav">
      <h2 class="hasAnchor">
<a href="#tocnav" class="anchor"></a>Contents</h2>
      <ul class="nav nav-pills nav-stacked">
<li>
<a href="#pibble">pibble</a><ul class="nav nav-pills nav-stacked">
<li><a href="#pibble-and-as_pibble">pibble() and as_pibble()</a></li>
      <li><a href="#panel_convert">panel_convert()</a></li>
      </ul>
</li>
      <li>
<a href="#id-and-time-variables">ID and Time Variables</a><ul class="nav nav-pills nav-stacked">
<li><a href="#id_variable">id_variable()</a></li>
      <li><a href="#time_variable">time_variable()</a></li>
      </ul>
</li>
      <li>
<a href="#filling-in-data">Filling in Data</a><ul class="nav nav-pills nav-stacked">
<li><a href="#panel_fill">panel_fill()</a></li>
      <li><a href="#panel_locf">panel_locf()</a></li>
      </ul>
</li>
      <li>
<a href="#panel-consistency">Panel Consistency</a><ul class="nav nav-pills nav-stacked">
<li><a href="#fixed_check">fixed_check()</a></li>
      <li><a href="#fixed_force">fixed_force()</a></li>
      </ul>
</li>
      <li>
<a href="#joins">Joins</a><ul class="nav nav-pills nav-stacked">
<li><a href="#inexact_join">inexact_join()</a></li>
      <li><a href="#safe_join">safe_join()</a></li>
      </ul>
</li>
      <li>
<a href="#mutate-variations">Mutate Variations</a><ul class="nav nav-pills nav-stacked">
<li><a href="#mutate_subset">mutate_subset()</a></li>
      <li><a href="#mutate_cascade">mutate_cascade()</a></li>
      </ul>
</li>
      <li><a href="#tlag">tlag()</a></li>
      <li>
<a href="#additional-calculations">Additional Calculations</a><ul class="nav nav-pills nav-stacked">
<li><a href="#between_i">between_i()</a></li>
      <li><a href="#within_i">within_i()</a></li>
      <li><a href="#mode_order">mode_order()</a></li>
      </ul>
</li>
      </ul>
</div>
      </div>

</div>



      <footer><div class="copyright">
  <p>Developed by Nick Huntington-Klein, Philip Khor.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.3.0.9100.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
